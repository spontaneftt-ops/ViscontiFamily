<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V.O.M | Visconti Ailesi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: #cfb53b; font-family: 'Cinzel', serif; margin-bottom: 20px;">V.O.M ACCESS</h2>
            <input type="email" id="email" class="input-dark" placeholder="Kimlik (@visconti.family)" style="margin-bottom: 10px;">
            <input type="password" id="password" class="input-dark" placeholder="Şifre" style="margin-bottom: 20px;">
            <button class="btn-action btn-gold" id="btnLogin" style="width: 100%; padding: 12px;">SİSTEME GİR</button>
            <p id="loginMsg" style="color: var(--red); margin-top: 10px; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div id="main-interface" class="hidden">
        <div class="top-bar">
            <div style="font-family: 'Share Tech Mono', monospace; color: #cfb53b;">
                <i class="fas fa-crown"></i> <span id="display-name">...</span> 
                <span style="color: #444;">|</span> 
                <span id="display-rank" style="color: #fff; font-weight:bold;">...</span>
            </div>
            <button class="btn-action btn-red" id="btnLogout">ÇIKIŞ</button>
        </div>

        <div class="workspace">
            <div class="sidebar">
                <div class="module-btn active" onclick="showModule('dashboard')"><i class="fas fa-home"></i> Ana Panel</div>
                
                <div class="module-btn restricted role-apps" onclick="showModule('apps')"><i class="fas fa-folder-open"></i> Başvurular <span id="app-count" style="background:#c0392b; color:#fff; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:auto;">0</span></div>
                <div class="module-btn restricted role-perms" onclick="showModule('perms')"><i class="fas fa-users-cog"></i> Personel & Yetkiler</div>
                
                <div class="module-btn restricted role-finance" onclick="showModule('finance')"><i class="fas fa-coins"></i> Kasa (Diamond)</div>
                <div class="module-btn restricted role-diplo" onclick="showModule('diplo')"><i class="fas fa-handshake"></i> Diplomasi</div>
                <div class="module-btn restricted role-strategy" onclick="showModule('strategy')"><i class="fas fa-map-marked-alt"></i> Bölge & İnşaat</div>
                <div class="module-btn restricted role-cyber" onclick="showModule('cyber')"><i class="fas fa-network-wired"></i> Siber Ağ (Oracle)</div>
                <div class="module-btn restricted role-intel" onclick="showModule('intel')"><i class="fas fa-user-secret"></i> İstihbarat (Wraith)</div>
                <div class="module-btn restricted role-hitlist" onclick="showModule('hitlist')"><i class="fas fa-crosshairs"></i> İnfaz Listesi</div>
                <div class="module-btn restricted role-clean" onclick="showModule('cleanup')"><i class="fas fa-biohazard"></i> Temizlik (Cleaner)</div>
            </div>

            <div class="content-area">
                
                <div id="mod-dashboard" class="module-view active">
                    <h2 style="color: #cfb53b; border-bottom: 1px solid #333; padding-bottom: 10px;">Hoş Geldin</h2>
                    <p>Visconti Mainframe aktif.</p>
                </div>

                <div id="mod-apps" class="module-view">
                    <h2 style="color: #e91e63;">Başvuru & İK Merkezi</h2>
                    <div id="app-list">Yükleniyor...</div>
                </div>

                <div id="mod-perms" class="module-view">
                    <h2 style="color: #9b59b6;">Aktif Personel Listesi</h2>
                    <p style="margin-bottom: 20px; font-size: 0.9rem; color: #666;">Aileye kabul edilmiş üyelerin yetkilerini buradan yapılandır.</p>
                    
                    <div id="personnel-list-container" class="personnel-list-container">
                        Yükleniyor...
                    </div>
                </div>

                <div id="mod-finance" class="module-view">
                    <h2 style="color: #3498db;">Hazine Yönetimi</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="fin-desc" class="input-dark" placeholder="Açıklama">
                        <input type="number" id="fin-amount" class="input-dark" placeholder="Miktar">
                        <select id="fin-type" class="input-dark"><option>GELİR</option><option>GİDER</option></select>
                        <button class="btn-action btn-green" onclick="addFinance()">KAYDET</button>
                    </div>
                    <div id="finance-list"></div>
                </div>

                <div id="mod-strategy" class="module-view">
                    <h2 style="color: #2ecc71;">Bölge Kontrol & İnşaat</h2>
                    <textarea id="strat-note" class="input-dark" rows="5" placeholder="Not..."></textarea>
                    <button class="btn-action btn-green" onclick="addNote('strategy')">PLANI YAYINLA</button>
                    <div id="list-strategy" style="margin-top:20px;"></div>
                </div>

                <div id="mod-cyber" class="module-view">
                    <h2 style="color: #00bcd4;">Oracle Siber Ağı</h2>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <input type="text" id="cyber-target" class="input-dark" placeholder="IP / Kişi">
                            <textarea id="cyber-info" class="input-dark" rows="3" placeholder="Bilgi..."></textarea>
                            <button class="btn-action btn-blue" onclick="addNote('cyber')">VERİ GİRİŞİ</button>
                        </div>
                        <div id="list-cyber" style="background:rgba(0,0,0,0.3); padding:10px; height:300px; overflow-y:auto; font-family:'Share Tech Mono'; color:#00bcd4;"></div>
                    </div>
                </div>

                <div id="mod-cleanup" class="module-view">
                    <h2 style="color: #7f8c8d;">Temizlik</h2>
                    <input type="text" id="clean-loc" class="input-dark" placeholder="Konum">
                    <button class="btn-action btn-red" onclick="addNote('cleanup')">EKİP GÖNDER</button>
                    <div id="list-cleanup"></div>
                </div>

                <div id="mod-intel" class="module-view"><h2>İstihbarat</h2><div id="list-intel"></div></div>
                <div id="mod-diplo" class="module-view"><h2>Diplomasi</h2><div id="list-diplo"></div></div>
                <div id="mod-hitlist" class="module-view"><h2>İnfaz Listesi</h2><div id="list-hitlist"></div></div>

            </div>
        </div>
    </div>

    <div id="modal-perm" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#fff; margin-bottom:15px;">Yetki Ver: <span id="modal-username" style="color:#3498db;"></span></h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <label><input type="checkbox" id="p_apps"> Başvuru Yönetimi</label>
                <label><input type="checkbox" id="p_finance"> Kasa Erişimi</label>
                <label><input type="checkbox" id="p_strategy"> Strateji (Architect)</label>
                <label><input type="checkbox" id="p_cyber"> Siber Ağ (Oracle)</label>
                <label><input type="checkbox" id="p_clean"> Temizlik (Cleaner)</label>
                <label><input type="checkbox" id="p_admin" style="accent-color:red;"> <span style="color:red;">BOSS Paneli</span></label>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-action btn-green" onclick="savePerms()" style="flex:1;">KAYDET</button>
                <button class="btn-action btn-red" onclick="document.getElementById('modal-perm').style.display='none'" style="flex:1;">İPTAL</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, getDocs, query, where, orderBy, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdoh5yMYMpnmddGpCzXyQtDhSnXo8cLHg",
            authDomain: "veltora.firebaseapp.com",
            databaseURL: "https://veltora-default-rtdb.firebaseio.com",
            projectId: "veltora",
            storageBucket: "veltora.firebasestorage.app",
            messagingSenderId: "62609466462",
            appId: "1:62609466462:web:5813c33c88df4f212600cf",
            measurementId: "G-PQBJN0MLXR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const WEBHOOK_URL = "https://discord.com/api/webhooks/1465195587577057454/Kk3hwNtZ8STa8NqOMcyk34E3Qig9ZU2Mf4stZ2eqZdzWvv5sibDw1tSuwWVsWM7qGaoT";

        const PERMISSIONS = {
            'THE SHROUD': ['all'], 
            'THE DIAMOND': ['finance', 'diplo', 'apps', 'strategy'],
            'THE PRINCESS': ['apps', 'diplo', 'perms'],
            'THE ARCHITECT': ['strategy', 'finance'],
            'BLOODLINE': ['diplo'],
            'OVERSEER': ['blacklist', 'intel', 'apps'],
            'GRAVEDIGGER': ['hitlist', 'clean'],
            'WRAITH': ['intel'],
            'ORACLE': ['cyber', 'intel'],
            'HARBINGER': ['diplo'],
            'CADAVER': [],
            'CLEANER': ['clean'],
            'VISCONTI Aile Üyesi': []
        };

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await checkUser(user.email);
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-interface').classList.add('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('loginMsg').innerText = err.message);
        });
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        async function checkUser(email) {
            if(email === "baron@visconti.family") {
                setupSession("Kadir Baba", "THE SHROUD", true);
                return;
            }
            // Normal kullanıcı girişi kapalı (demo)
            alert("Sadece Baron girişi aktif. (baron@visconti.family)");
            signOut(auth);
        }

        function setupSession(name, rank, isBoss) {
            currentUser = name;
            document.getElementById('display-name').innerText = name.toUpperCase();
            document.getElementById('display-rank').innerText = rank;
            
            const rankEl = document.getElementById('display-rank');
            if(rank === 'THE SHROUD') rankEl.style.color = 'var(--gold)';
            if(rank === 'THE DIAMOND') rankEl.style.color = 'var(--diamond)';
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('main-interface').style.display = 'flex';

            if(rank === 'THE SHROUD') {
                document.querySelectorAll('.restricted').forEach(el => el.classList.remove('restricted'));
            } else {
                (PERMISSIONS[rank] || []).forEach(p => {
                    document.querySelectorAll(`.role-${p}`).forEach(el => el.classList.remove('restricted'));
                });
            }
            initListeners();
        }

        window.showModule = (id) => {
            document.querySelectorAll('.module-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.module-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('mod-'+id).classList.add('active');
        };

        function initListeners() {
            // BAŞVURULARI DİNLE
            onSnapshot(query(collection(db, "basvurular"), orderBy("tarih", "desc")), (snap) => {
                let htmlApps = '';
                let htmlPersonnel = ''; // Yeni Personel Listesi
                let pendingCount = 0;
                
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const id = docSnap.id;
                    
                    // Bekleyenler Başvurulara
                    if(d.durum === 'Beklemede') {
                        pendingCount++;
                        const ranks = `
                            <select id="rank-${id}" class="rank-select">
                                <option value="">Rütbe Ata...</option>
                                <option value="VISCONTI Aile Üyesi">VISCONTI Aile Üyesi</option>
                                <option value="CLEANER">CLEANER</option>
                                <option value="CADAVER">CADAVER</option>
                                <option value="HARBINGER">HARBINGER</option>
                                <option value="ORACLE">ORACLE</option>
                                <option value="WRAITH">WRAITH</option>
                                <option value="GRAVEDIGGER">GRAVEDIGGER</option>
                                <option value="OVERSEER">OVERSEER</option>
                                <option value="BLOODLINE">BLOODLINE</option>
                                <option value="THE ARCHITECT">THE ARCHITECT</option>
                                <option value="THE PRINCESS">THE PRINCESS</option>
                                <option value="THE DIAMOND">THE DIAMOND</option>
                            </select>
                        `;
                        const actions = `
                            <div class="action-bar">
                                ${ranks}
                                <button class="btn-action btn-green" onclick="window.decideApp('${id}', true)">ONAYLA</button>
                                <button class="btn-action btn-red" onclick="window.decideApp('${id}', false)">REDDET</button>
                            </div>
                        `;
                        htmlApps += `
                            <div class="app-card">
                                <div class="app-header">
                                    <strong style="color:#cfb53b;">${d.icName}</strong>
                                    <span class="app-status status-${d.durum}">${d.durum}</span>
                                </div>
                                <div class="app-details"><span>Discord: ${d.discord}</span><span>Yaş: ${d.icAge}</span><button class="btn-action btn-blue" onclick="document.getElementById('story-${id}').style.display='block'">Hikaye</button></div>
                                <div id="story-${id}" class="story-content">${d.story}</div>
                                ${actions}
                            </div>
                        `;
                    } 
                    // Onaylananlar Personel Listesine
                    else if(d.durum === 'Onaylandı') {
                        htmlPersonnel += `
                            <div class="personnel-row">
                                <div class="p-info">
                                    <span class="p-name">${d.icName}</span>
                                    <span class="p-rank">${d.rank || 'Üye'}</span>
                                </div>
                                <button class="btn-action btn-blue" onclick="openPermModal('${d.icName}')">YAPILANDIR</button>
                            </div>
                        `;
                    }
                });

                document.getElementById('app-list').innerHTML = htmlApps || '<p style="color:#666;">Bekleyen başvuru yok.</p>';
                document.getElementById('app-count').innerText = pendingCount;
                document.getElementById('personnel-list-container').innerHTML = htmlPersonnel || '<p style="color:#666;">Aktif personel bulunamadı.</p>';
            });
            
            listenSimple('vom_finance', 'finance-list');
            listenSimple('vom_cyber', 'list-cyber');
            listenSimple('vom_cleanup', 'list-cleanup');
            listenSimple('vom_strategy', 'list-strategy');
        }

        function listenSimple(coll, elId) {
            onSnapshot(query(collection(db, coll), orderBy("date", "desc")), (snap) => {
                let h = '';
                snap.forEach(d => {
                    const x = d.data();
                    h += `<div style="border-bottom:1px solid #333; padding:5px; font-size:0.9rem;"><span style="color:var(--gold)">${x.user}:</span> ${x.info || x.desc} ${x.amount ? `(${x.amount}$)` : ''}</div>`;
                });
                document.getElementById(elId).innerHTML = h || 'Veri yok.';
            });
        }

        window.decideApp = async (id, isApproved) => {
            const rankVal = document.getElementById(`rank-${id}`).value;
            if(isApproved && !rankVal) { alert("Lütfen rütbe seçin!"); return; }

            const status = isApproved ? "Onaylandı" : "Reddedildi";
            
            await updateDoc(doc(db, "basvurular", id), {
                durum: status,
                rank: isApproved ? rankVal : "Reddedildi",
                processedBy: currentUser,
                processedAt: serverTimestamp()
            });

            const msg = isApproved ? `✅ **KABUL EDİLDİ**\nYeni Üye: **${rankVal}**` : `⛔ **REDDEDİLDİ**`;
            await fetch(WEBHOOK_URL, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: "V.O.M Yönetim",
                    avatar_url: "https://raw.githubusercontent.com/baron/visconti/main/Visconti.jpg",
                    embeds: [{ title: "Başvuru Sonucu", description: msg, color: isApproved ? 3066993 : 15158332 }]
                })
            });
            alert("İşlem tamam.");
        };

        window.addNote = async (type) => {
            let data = { user: currentUser, date: serverTimestamp() };
            if(type === 'cyber') data.info = `HEDEF: ${document.getElementById('cyber-target').value} | BİLGİ: ${document.getElementById('cyber-info').value}`;
            else if(type === 'cleanup') data.info = `BÖLGE: ${document.getElementById('clean-loc').value}`;
            else if(type === 'strategy') data.info = document.getElementById('strat-note').value;
            
            await addDoc(collection(db, `vom_${type}`), data);
        };

        window.addFinance = async () => {
            const desc = document.getElementById('fin-desc').value;
            const am = document.getElementById('fin-amount').value;
            const type = document.getElementById('fin-type').value;
            if(!desc) return;
            await addDoc(collection(db, "vom_finance"), { desc, amount: am, type, user: currentUser, date: serverTimestamp() });
        };

        // --- YETKİ MODALI (YENİ SİSTEM) ---
        window.openPermModal = (username) => {
            document.getElementById('modal-username').innerText = username;
            document.getElementById('modal-perm').style.display = 'flex';
        };

        window.savePerms = async () => {
            const u = document.getElementById('modal-username').innerText;
            const p = {
                apps: document.getElementById('p_apps').checked,
                finance: document.getElementById('p_finance').checked,
                strategy: document.getElementById('p_strategy').checked,
                cyber: document.getElementById('p_cyber').checked,
                clean: document.getElementById('p_clean').checked,
                admin: document.getElementById('p_admin').checked
            };
            await setDoc(doc(db, "vom_permissions", u), p);
            alert("Yetkiler güncellendi.");
            document.getElementById('modal-perm').style.display = 'none';
        };
    </script>
</body>
</html>
