<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visconti Admin | High Council</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #0f1014; --card-bg: #18191e; --text-color: #c4c4c4; --accent-gold: #cfb53b; --danger: #8a2020; --success: #1a4a25; --success-bright: #2ecc71; --danger-bright: #e74c3c; --perm-purple: #9b59b6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; }
        
        /* Header */
        .admin-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: rgba(0,0,0,0.6); border-bottom: 1px solid #333; backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 50; }
        .admin-title { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .btn-logout { background: transparent; border: 1px solid #666; color: #fff; padding: 8px 15px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .btn-logout:hover { border-color: var(--danger-bright); color: var(--danger-bright); }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f1014; z-index: 100; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 12px; border: 1px solid var(--accent-gold); text-align: center; width: 90%; max-width: 400px; box-shadow: 0 0 50px rgba(207, 181, 59, 0.1); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; }
        .btn-login { width: 100%; padding: 12px; background: var(--accent-gold); border: none; font-weight: bold; cursor: pointer; color: #000; border-radius: 4px; margin-top: 10px; font-family: 'Cinzel', serif; }

        /* Navigation Tabs */
        .nav-tabs { display: flex; justify-content: center; margin-top: 20px; gap: 20px; }
        .tab-btn { background: transparent; border: 1px solid #333; color: #666; padding: 10px 30px; cursor: pointer; font-family: 'Cinzel', serif; font-size: 1.1rem; border-radius: 6px; transition: 0.3s; }
        .tab-btn.active { border-color: var(--accent-gold); color: var(--accent-gold); background: rgba(207, 181, 59, 0.05); box-shadow: 0 0 15px rgba(207, 181, 59, 0.2); }
        .tab-btn:hover { color: #fff; }

        /* Dashboard */
        .dashboard-container { padding: 40px; max-width: 1400px; margin: 0 auto; display: none; }
        .section-view { display: none; } 
        .section-view.active { display: block; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .app-card { background: var(--card-bg); border-radius: 8px; padding: 20px; border: 1px solid #333; position: relative; transition: transform 0.2s; display: flex; flex-direction: column; }
        .app-card:hover { transform: translateY(-3px); border-color: #444; }
        .app-card.member-card { border-left: 3px solid var(--accent-gold); }
        
        .app-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .discord-link { color: #7289da; font-weight: bold; text-decoration: none; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        .discord-link:hover { color: #fff; }

        .story-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-size: 0.9rem; max-height: 150px; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; margin-bottom: 20px; color: #aaa; }
        
        /* Rank Selector */
        .rank-selector-container { margin-top: auto; padding-top: 15px; border-top: 1px solid #333; }
        .rank-label { font-size: 0.8rem; color: var(--accent-gold); margin-bottom: 5px; display: block; font-family: 'Cinzel', serif; }
        .rank-select { width: 100%; background: #0a0a0c; color: #fff; padding: 10px; border: 1px solid #444; border-radius: 4px; cursor: pointer; outline: none; font-family: 'Inter', sans-serif; }
        
        /* Action Buttons */
        .action-bar { display: flex; gap: 10px; margin-top: auto; padding-top: 10px; border-top: 1px solid #333; }
        .btn-action { flex: 1; padding: 8px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; font-family: 'Cinzel', serif; transition: 0.3s; color: #000; }
        .btn-approve { background: #27ae60; color: #fff; }
        .btn-reject { background: #c0392b; color: #fff; }
        .btn-delete-icon { position: absolute; bottom: 20px; right: 20px; color: #555; cursor: pointer; transition: 0.3s; font-size: 1.2rem; }
        .btn-delete-icon:hover { color: var(--danger-bright); }
        
        /* √ñzel Yetki ƒ∞konu */
        .btn-perm-icon { position: absolute; bottom: 20px; right: 50px; color: var(--perm-purple); cursor: pointer; transition: 0.3s; font-size: 1.2rem; }
        .btn-perm-icon:hover { text-shadow: 0 0 10px var(--perm-purple); transform: scale(1.1); }

        .btn-save-rank { width: 100%; margin-top: 10px; padding: 8px; background: var(--accent-gold); color: #000; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .btn-save-rank:hover { filter: brightness(1.2); }

        /* MANUEL EKLEME BUTONU */
        .btn-manual-add { background: linear-gradient(45deg, var(--accent-gold), #8a7620); color: #000; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; font-family: 'Cinzel', serif; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; margin-bottom: 20px; }
        .btn-manual-add:hover { box-shadow: 0 0 15px rgba(207, 181, 59, 0.4); transform: translateY(-2px); }

        /* MODAL GENEL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #15161a; width: 90%; max-width: 500px; padding: 30px; border-radius: 8px; border: 1px solid var(--accent-gold); box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 20px; color: #fff; cursor: pointer; font-size: 1.5rem; }
        .modal-title { font-family: 'Cinzel', serif; color: var(--accent-gold); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* √ñZEL YETKƒ∞ MODALI CSS */
        .perm-header-text { color: #3498db; font-size: 1.1rem; margin-bottom: 10px; font-weight: bold; }
        .perm-warning { color: #7f8c8d; font-size: 0.85rem; margin-bottom: 20px; border-left: 2px solid #555; padding-left: 10px; }
        
        .perm-item { display: flex; align-items: flex-start; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .perm-checkbox { width: 20px; height: 20px; margin-right: 15px; accent-color: #3498db; cursor: pointer; margin-top: 3px; }
        .perm-label { color: #ecf0f1; font-weight: bold; font-size: 0.95rem; cursor: pointer; }
        .perm-desc { display: block; color: #95a5a6; font-size: 0.8rem; font-weight: normal; margin-top: 3px; }
        
        .perm-item.danger .perm-checkbox { accent-color: #e74c3c; }
        .perm-item.danger .perm-label { color: #e74c3c; }

        .btn-perm-save { width: 100%; padding: 12px; background: #00b894; color: #fff; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .btn-perm-save:hover { background: #00cec9; box-shadow: 0 0 15px rgba(0, 184, 148, 0.4); }

    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <img src="Visconti.jpg" alt="Logo" style="width: 80px; border-radius: 50%; border: 2px solid var(--accent-gold); margin-bottom: 15px;">
            <h2 style="font-family: 'Cinzel', serif; color: var(--accent-gold); margin-bottom: 20px;">Baron Giri≈üi</h2>
            <input type="email" id="adminEmail" class="login-input" placeholder="Email">
            <input type="password" id="adminPass" class="login-input" placeholder="≈ûifre">
            <button class="btn-login" id="loginBtn">Giri≈ü Yap</button>
            <p id="loginError" style="color: #8a2020; margin-top: 10px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div id="manualModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="window.closeModal('manualModal')">&times;</span>
            <h3 class="modal-title">Manuel Aile √úyesi Kaydƒ±</h3>
            <input type="text" id="manualDiscord" class="login-input" placeholder="Discord ID">
            <input type="text" id="manualName" class="login-input" placeholder="IC ƒ∞sim Soyisim">
            <input type="number" id="manualAge" class="login-input" placeholder="IC Ya≈ü">
            <select id="manualRank" class="rank-select" style="margin-top:10px; background:#000; color:#fff;"></select>
            <button class="btn-login" id="btnManualSubmit" onclick="window.submitManualRegister()">Kayƒ±t Olu≈ütur ve Ekle</button>
        </div>
    </div>

    <div id="permModal" class="modal-overlay">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <span class="modal-close" onclick="window.closeModal('permModal')">&times;</span>
            <h3 class="modal-title"><i class="fas fa-user-shield"></i> √ñzel Yetki Yapƒ±landƒ±rmasƒ±</h3>
            
            <div class="perm-header-text">Kullanƒ±cƒ±: <span id="permUserName" style="color:#fff;">...</span></div>
            <div class="perm-warning">
                Dikkat: A≈üaƒüƒ±daki yetkiler se√ßildiƒüinde, kullanƒ±cƒ±nƒ±n r√ºtbesi yetersiz olsa bile i≈ülemi yapmasƒ±na izin verilir.
            </div>

            <form id="permForm">
                <div class="perm-item">
                    <input type="checkbox" id="perm_applications" class="perm-checkbox">
                    <label for="perm_applications" class="perm-label">Ba≈üvuru Y√∂netimi
                        <span class="perm-desc">Ba≈üvurularƒ± onaylayabilir/reddedebilir.</span>
                    </label>
                </div>
                <div class="perm-item">
                    <input type="checkbox" id="perm_finance" class="perm-checkbox">
                    <label for="perm_finance" class="perm-label">Kasa Eri≈üimi
                        <span class="perm-desc">Aile kasasƒ±na para ekleyip √ßekebilir.</span>
                    </label>
                </div>
                <div class="perm-item">
                    <input type="checkbox" id="perm_penalty" class="perm-checkbox">
                    <label for="perm_penalty" class="perm-label">Ceza Kesme Yetkisi
                        <span class="perm-desc">Sisteme ceza ve infaz i≈üleyebilir.</span>
                    </label>
                </div>
                <div class="perm-item">
                    <input type="checkbox" id="perm_personnel" class="perm-checkbox">
                    <label for="perm_personnel" class="perm-label">Personel Y√∂netimi
                        <span class="perm-desc">Personel r√ºtbelerini deƒüi≈ütirebilir.</span>
                    </label>
                </div>
                <div class="perm-item danger">
                    <input type="checkbox" id="perm_kick" class="perm-checkbox">
                    <label for="perm_kick" class="perm-label">Personel Kovma Yetkisi
                        <span class="perm-desc">Personeli sistemden kalƒ±cƒ± olarak Sƒ∞LEBƒ∞Lƒ∞R.</span>
                    </label>
                </div>
                <div class="perm-item" style="border-left: 2px solid #9b59b6; padding-left: 10px;">
                    <input type="checkbox" id="perm_access" class="perm-checkbox">
                    <label for="perm_access" class="perm-label" style="color:#9b59b6;">Yetki Y√∂netimi (Eri≈üim)
                        <span class="perm-desc">Personel listesindeki mor 'YETKƒ∞' butonunu g√∂rebilir.</span>
                    </label>
                </div>
                <div class="perm-item">
                    <input type="checkbox" id="perm_blacklist" class="perm-checkbox">
                    <label for="perm_blacklist" class="perm-label">Kara Liste Y√∂netimi
                        <span class="perm-desc">Ki≈üileri banlayabilir (Blacklist).</span>
                    </label>
                </div>
                <div class="perm-item">
                    <input type="checkbox" id="perm_diplomacy" class="perm-checkbox">
                    <label for="perm_diplomacy" class="perm-label">Diplomasi
                        <span class="perm-desc">Diƒüer ailelerle ili≈üki durumunu g√ºncelleyebilir.</span>
                    </label>
                </div>
                <div class="perm-item danger">
                    <input type="checkbox" id="perm_delete_record" class="perm-checkbox">
                    <label for="perm_delete_record" class="perm-label">Kayƒ±t Silme
                        <span class="perm-desc">Sistemdeki loglarƒ± ve kayƒ±tlarƒ± silebilir.</span>
                    </label>
                </div>
            </form>

            <button class="btn-perm-save" id="btnSavePerms">YETKƒ∞LERƒ∞ G√úNCELLE</button>
        </div>
    </div>

    <div class="admin-header">
        <div class="admin-title"><i class="fas fa-chess-king"></i> Visconti Management</div>
        <button class="btn-logout" id="logoutBtn">√áƒ±kƒ±≈ü</button>
    </div>

    <div class="dashboard-container" id="dashboard">
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('basvurular')">Ba≈üvurular (Yeni)</button>
            <button class="tab-btn" onclick="switchTab('uyeler')">Aile Konseyi (√úyeler)</button>
        </div>

        <br><hr style="border-color: #333; opacity: 0.3;"><br>

        <div id="view-basvurular" class="section-view active">
            <h3 style="color: #888; margin-bottom: 20px; font-family: 'Cinzel', serif;">Bekleyen ƒ∞ncelemeler</h3>
            <div class="grid" id="applicationsGrid"><p style="color: #666;">Y√ºkleniyor...</p></div>
        </div>

        <div id="view-uyeler" class="section-view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="color: var(--accent-gold); font-family: 'Cinzel', serif;">Aktif Aile √úyeleri & Hiyerar≈üi</h3>
                <button class="btn-manual-add" onclick="window.openManualModal()"><i class="fas fa-plus-circle"></i> Hƒ±zlƒ± √úye Ekle</button>
            </div>
            <div class="grid" id="membersGrid"><p style="color: #666;">Y√ºkleniyor...</p></div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, orderBy, query, deleteDoc, updateDoc, addDoc, doc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdoh5yMYMpnmddGpCzXyQtDhSnXo8cLHg",
            authDomain: "veltora.firebaseapp.com",
            databaseURL: "https://veltora-default-rtdb.firebaseio.com",
            projectId: "veltora",
            storageBucket: "veltora.firebasestorage.app",
            messagingSenderId: "62609466462",
            appId: "1:62609466462:web:5813c33c88df4f212600cf",
            measurementId: "G-PQBJN0MLXR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1465195587577057454/Kk3hwNtZ8STa8NqOMcyk34E3Qig9ZU2Mf4stZ2eqZdzWvv5sibDw1tSuwWVsWM7qGaoT";

        const VISCONTI_RANKS = [
            { name: "Visconti Aile √úyesi", color: "#e74c3c", icon: "üî¥" }, 
            { name: "THE SHROUD", color: "#d4af37", icon: "üëë" },
            { name: "THE DIAMOND", color: "#3498db", icon: "üíé" },
            { name: "THE PRINCESS", color: "#e91e63", icon: "üëÅÔ∏è" },
            { name: "THE ARCHITECT", color: "#2ecc71", icon: "üëÅÔ∏è" },
            { name: "BLOODLINE", color: "#c0392b", icon: "ü©∏" },
            { name: "OVERSEER", color: "#95a5a6", icon: "üíÄ" },
            { name: "GRAVEDIGGER", color: "#8e44ad", icon: "‚ö∞Ô∏è" },
            { name: "WRAITH", color: "#bdc3c7", icon: "üëª" },
            { name: "ORACLE", color: "#1abc9c", icon: "üåê" },
            { name: "HARBINGER", color: "#f1c40f", icon: "‚öñÔ∏è" },
            { name: "CADAVER", color: "#7f8c8d", icon: "‚õìÔ∏è" },
            { name: "CLEANER", color: "#f39c12", icon: "üíâ" }
        ];

        let currentTargetUserId = null; // Yetki d√ºzenlenecek ki≈üinin ID'si

        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');

        // AUTH STATE
        onAuthStateChanged(auth, (user) => {
            if (user) { 
                loginScreen.style.display = 'none'; 
                dashboard.style.display = 'block'; 
                refreshAllData();
                fillRankDropdown();
            } else { 
                loginScreen.style.display = 'flex'; 
                dashboard.style.display = 'none'; 
            }
        });

        // LOGIN / LOGOUT
        document.getElementById('loginBtn').addEventListener('click', () => {
            signInWithEmailAndPassword(auth, document.getElementById('adminEmail').value, document.getElementById('adminPass').value)
                .catch((err) => document.getElementById('loginError').innerText = "Hatalƒ± Giri≈ü: " + err.message);
        });
        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        // TAB SWITCHING
        window.switchTab = (tabName) => {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        };

        // --- MANUEL KAYIT MODAL ---
        function fillRankDropdown() {
            const select = document.getElementById('manualRank');
            select.innerHTML = '';
            VISCONTI_RANKS.forEach(r => {
                select.innerHTML += `<option value="${r.name}">${r.icon} ${r.name}</option>`;
            });
        }
        window.openManualModal = () => document.getElementById('manualModal').style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        window.submitManualRegister = async () => {
            const discord = document.getElementById('manualDiscord').value;
            const name = document.getElementById('manualName').value;
            const age = document.getElementById('manualAge').value;
            const rank = document.getElementById('manualRank').value;
            const btn = document.getElementById('btnManualSubmit');

            if(!discord || !name || !age) { alert("T√ºm alanlarƒ± doldur."); return; }

            btn.innerText = "ƒ∞≈üleniyor...";
            btn.disabled = true;

            const randomPass = Math.random().toString(36).slice(-8); 
            const safeName = name.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
            const generatedEmail = `${safeName}${Math.floor(Math.random() * 1000)}@visconti.family`;

            try {
                await createUserWithEmailAndPassword(secondaryAuth, generatedEmail, randomPass);
                await addDoc(collection(db, "basvurular"), {
                    discord: discord, icName: name, icAge: age, rank: rank,
                    durum: "Onaylandƒ±", systemEmail: generatedEmail, story: "Manuel Y√∂netici Kaydƒ±",
                    tarih: serverTimestamp()
                });
                await sendManualToDiscord({ discord, icName: name, generatedEmail, randomPass, rank });
                alert(`Kayƒ±t Ba≈üarƒ±lƒ±!\nKullanƒ±cƒ±: ${generatedEmail}\n≈ûifre: ${randomPass}`);
                window.closeModal('manualModal');
                refreshAllData();
            } catch (err) { alert("Hata: " + err.message); } 
            finally { btn.innerText = "Kayƒ±t Olu≈ütur ve Ekle"; btn.disabled = false; }
        };

        // --- YENƒ∞: √ñZEL YETKƒ∞ MODAL ƒ∞≈ûLEMLERƒ∞ ---
        window.openPermModal = async (docId, userName, currentPerms) => {
            currentTargetUserId = docId;
            document.getElementById('permUserName').innerText = userName;
            
            // T√ºm checkboxlarƒ± sƒ±fƒ±rla
            document.querySelectorAll('.perm-checkbox').forEach(cb => cb.checked = false);

            // Mevcut yetkileri i≈üaretle
            if(currentPerms && Array.isArray(currentPerms)) {
                currentPerms.forEach(permId => {
                    const el = document.getElementById(permId);
                    if(el) el.checked = true;
                });
            }

            document.getElementById('permModal').style.display = 'flex';
        };

        document.getElementById('btnSavePerms').addEventListener('click', async () => {
            if(!currentTargetUserId) return;
            const btn = document.getElementById('btnSavePerms');
            btn.innerText = "KAYDEDƒ∞Lƒ∞YOR...";
            
            // Se√ßili yetkileri topla
            const selectedPerms = [];
            document.querySelectorAll('.perm-checkbox').forEach(cb => {
                if(cb.checked) selectedPerms.push(cb.id);
            });

            try {
                await updateDoc(doc(db, "basvurular", currentTargetUserId), {
                    customPermissions: selectedPerms
                });
                alert("√ñzel yetkiler g√ºncellendi.");
                window.closeModal('permModal');
                refreshAllData(); // Listeyi yenile ki buton onclick verisi g√ºncellensin
            } catch (err) {
                console.error(err);
                alert("Hata olu≈ütu.");
            } finally {
                btn.innerText = "YETKƒ∞LERƒ∞ G√úNCELLE";
            }
        });

        async function refreshAllData() {
            loadApplications(); 
            loadMembers();      
        }

        // --- 1. BA≈ûVURULAR ---
        async function loadApplications() {
            const grid = document.getElementById('applicationsGrid');
            grid.innerHTML = '<p style="color:#666">Y√ºkleniyor...</p>';
            try {
                const q = query(collection(db, "basvurular"), where("durum", "==", "Beklemede"));
                const querySnapshot = await getDocs(q);
                grid.innerHTML = '';
                if (querySnapshot.empty) { grid.innerHTML = '<p style="color:#666">Bekleyen ba≈üvuru yok.</p>'; return; }
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const docId = docSnap.id;
                    const div = document.createElement('div');
                    div.className = 'app-card';
                    div.innerHTML = `
                        <div class="app-header">
                            <span class="discord-link"><i class="fab fa-discord"></i> ${data.discord}</span>
                            <span style="color:#f1c40f; font-size:0.8rem; border:1px solid #f1c40f; padding:2px 6px; border-radius:4px;">BEKLEMEDE</span>
                        </div>
                        <div style="color:#fff; font-weight:bold; margin-bottom:5px;">${data.icName} (${data.icAge})</div>
                        <div class="story-box">${data.story}</div>
                        <div class="action-bar">
                            <button class="btn-action btn-approve" onclick="window.approveApp('${docId}', '${data.discord}', '${data.icName}')">ONAYLA</button>
                            <button class="btn-action btn-reject" onclick="window.rejectApp('${docId}', '${data.discord}', '${data.icName}')">REDDET</button>
                        </div>
                        <i class="fas fa-trash btn-delete-icon" onclick="window.deleteApp('${docId}')"></i>
                    `;
                    grid.appendChild(div);
                });
            } catch (err) { console.error(err); grid.innerHTML = '<p style="color:red">Veri hatasƒ±.</p>'; }
        }

        // --- 2. √úYELER (G√úNCELLENDƒ∞: MOR BUTON EKLENDƒ∞) ---
        async function loadMembers() {
            const grid = document.getElementById('membersGrid');
            grid.innerHTML = '<p style="color:#666">Konsey toplanƒ±yor...</p>';

            try {
                const q = query(collection(db, "basvurular"), where("durum", "==", "Onaylandƒ±"));
                const querySnapshot = await getDocs(q);
                grid.innerHTML = '';

                if (querySnapshot.empty) { grid.innerHTML = '<p style="color:#666">Hen√ºz √ºye yok.</p>'; return; }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const docId = docSnap.id;
                    const currentRank = data.rank || "Visconti Aile √úyesi";
                    // Custom Perms verisini stringe √ßevirip fonksiyona yolluyoruz
                    const permsJson = JSON.stringify(data.customPermissions || []);

                    let rankOptions = '';
                    VISCONTI_RANKS.forEach(r => {
                        const isSelected = r.name === currentRank ? 'selected' : '';
                        rankOptions += `<option value="${r.name}" style="color:${r.color}" ${isSelected}>${r.icon} ${r.name}</option>`;
                    });

                    const div = document.createElement('div');
                    div.className = 'app-card member-card';
                    div.style.borderColor = getRankColor(currentRank);
                    
                    div.innerHTML = `
                        <div class="app-header">
                            <span class="discord-link"><i class="fab fa-discord"></i> ${data.discord}</span>
                            <i class="fas fa-check-circle" style="color: #2ecc71;"></i>
                        </div>
                        <div style="color:#fff; font-weight:bold;">${data.icName}</div>
                        <div style="color:#666; font-size:0.85rem; margin-bottom:10px;">${data.systemEmail ? data.systemEmail : 'E-posta tanƒ±mlƒ± deƒüil'}</div>
                        
                        <div class="rank-selector-container">
                            <label class="rank-label">R√ºtbe / Atama</label>
                            <select id="rank-${docId}" class="rank-select">
                                ${rankOptions}
                            </select>
                            <button class="btn-save-rank" onclick="window.updateMemberRank('${docId}', '${data.discord}', '${data.icName}')">
                                <i class="fas fa-save"></i> R√ºtbeyi Kaydet
                            </button>
                        </div>
                        
                        <i class="fas fa-user-shield btn-perm-icon" 
                           onclick='window.openPermModal("${docId}", "${data.icName}", ${permsJson})' 
                           title="√ñzel Yetki Yapƒ±landƒ±rmasƒ±"></i>

                        <i class="fas fa-user-slash btn-delete-icon" onclick="window.kickMember('${docId}', '${data.icName}')" title="Aileden At"></i>
                    `;
                    grid.appendChild(div);
                });
            } catch (err) { console.error(err); }
        }

        function getRankColor(rankName) {
            const rank = VISCONTI_RANKS.find(r => r.name === rankName);
            return rank ? rank.color : '#333';
        }

        // --- CRUD ƒ∞≈ûLEMLERƒ∞ (AYNEN KORUNDU) ---
        window.approveApp = async (id, discord, icName) => {
            if(!confirm(`${icName} ba≈üvurusunu onaylayƒ±p Sƒ∞STEM Gƒ∞Rƒ∞≈û Bƒ∞LGƒ∞LERƒ∞Nƒ∞ g√∂ndermek istiyor musun?`)) return;
            const randomPass = Math.random().toString(36).slice(-8);
            const safeName = icName.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
            const generatedEmail = `${safeName}${Math.floor(Math.random() * 100)}@visconti.family`;
            try {
                await createUserWithEmailAndPassword(secondaryAuth, generatedEmail, randomPass);
                await updateDoc(doc(db, "basvurular", id), { durum: "Onaylandƒ±", rank: "Visconti Aile √úyesi", systemEmail: generatedEmail });
                await sendToDiscord({ discord, icName, generatedEmail, randomPass }, "Onaylandƒ±");
                refreshAllData();
            } catch (err) { alert("Hata: " + err.message); }
        };

        window.rejectApp = async (id, discord, icName) => {
            if(!confirm(`${icName} ba≈üvurusunu reddediyor musun?`)) return;
            try { await updateDoc(doc(db, "basvurular", id), { durum: "Reddedildi" }); refreshAllData(); } 
            catch (err) { alert("Hata: " + err.message); }
        };

        window.updateMemberRank = async (docId, discord, icName) => {
            const select = document.getElementById(`rank-${docId}`);
            const newRank = select.value;
            const btn = select.nextElementSibling;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                await updateDoc(doc(db, "basvurular", docId), { rank: newRank });
                await sendRankUpdateToDiscord(discord, icName, newRank);
                alert(`${icName} artƒ±k: ${newRank}`); refreshAllData();
            } catch (err) { alert("G√ºncelleme ba≈üarƒ±sƒ±z."); }
        };

        window.kickMember = async (id, icName) => {
            if(confirm(`${icName} ki≈üisini aileden atƒ±p kaydƒ±nƒ± silmek istiyor musun?`)) { await deleteDoc(doc(db, "basvurular", id)); refreshAllData(); }
        };

        window.deleteApp = async (id) => {
            if(confirm('Kayƒ±t silinecek. Emin misin?')) { await deleteDoc(doc(db, "basvurular", id)); refreshAllData(); }
        };

        // --- DISCORD ---
        async function sendToDiscord(data, status) {
            let embedData = {};
            if (status === "Onaylandƒ±") {
                embedData = { title: "‚öúÔ∏è VISCONTI KONSEY KARARI: KABUL", desc: `**${data.icName}** kabul edildi.`, color: 3066993, fields: [{ name: "Ki≈üi", value: `<@${data.discord}>`, inline: true }, { name: "üîê Gƒ∞ZLƒ∞", value: `**E-posta:** ${data.generatedEmail}\n**≈ûifre:** ||${data.randomPass}||`, inline: false }] };
            } else {
                embedData = { title: "üíÄ VISCONTI MAHKEMESƒ∞: RET", desc: `**${data.icName}** reddedildi.`, color: 9052192, fields: [{ name: "Ki≈üi", value: `<@${data.discord}>`, inline: true }] };
            }
            await postWebhook(embedData);
        }

        async function sendManualToDiscord(data) {
             const rankObj = VISCONTI_RANKS.find(r => r.name === data.rank);
             const embedData = { title: "üî± VISCONTI Dƒ∞REKT ATAMA", desc: `Baron emriyle **${data.icName}** eklendi.`, color: parseInt(rankObj.color.replace("#",""), 16), fields: [{ name: "Ki≈üi", value: `<@${data.discord}>`, inline: true }, { name: "R√ºtbe", value: data.rank, inline: true }, { name: "üîê Gƒ∞ZLƒ∞", value: `**E-posta:** ${data.generatedEmail}\n**≈ûifre:** ||${data.randomPass}||`, inline: false }] };
            await postWebhook(embedData);
        }

        async function sendRankUpdateToDiscord(discord, icName, newRank) {
            const rankObj = VISCONTI_RANKS.find(r => r.name === newRank);
            const embedData = { title: "‚öñÔ∏è VISCONTI R√úTBE ATAMASI", desc: `**${icName}** -> **${newRank}**`, color: parseInt(rankObj.color.replace("#", ""), 16), fields: [{ name: "Ki≈üi", value: `<@${discord}>`, inline: true }] };
            await postWebhook(embedData);
        }

        async function postWebhook(embedData) {
            try { await fetch(DISCORD_WEBHOOK_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username: "Visconti High Council", avatar_url: "https://raw.githubusercontent.com/baron/visconti/main/Visconti.jpg", embeds: [{ title: embedData.title, description: embedData.desc, color: embedData.color, fields: embedData.fields, footer: { text: "Visconti Family", icon_url: "https://raw.githubusercontent.com/baron/visconti/main/Visconti.jpg" }, timestamp: new Date().toISOString() }] }) }); } catch(e) { console.error("Discord Error", e); }
        }

    </script>
</body>
</html>
