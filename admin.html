<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V.O.M | Yönetim Paneli</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: #cfb53b; font-family: 'Cinzel', serif; margin-bottom: 20px;">V.O.M ACCESS</h2>
            <input type="email" id="email" class="input-dark" placeholder="Kimlik (@visconti.family)" style="margin-bottom: 10px;">
            <input type="password" id="password" class="input-dark" placeholder="Şifre" style="margin-bottom: 20px;">
            <button class="btn-action btn-gold" id="btnLogin" style="width: 100%; padding: 12px;">SİSTEME GİR</button>
            <p id="loginMsg" style="color: var(--red); margin-top: 10px; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div id="main-interface" class="hidden">
        <div class="top-bar">
            <div style="font-family: 'Share Tech Mono', monospace; color: #cfb53b;">
                <i class="fas fa-user-circle"></i> <span id="display-name">...</span> 
                <span style="color: #444;">|</span> 
                <span id="display-rank" style="color: #fff;">...</span>
            </div>
            <button class="btn-action btn-red" id="btnLogout">ÇIKIŞ</button>
        </div>

        <div class="workspace">
            <div class="sidebar">
                <div class="module-btn active" onclick="showModule('dashboard')"><i class="fas fa-home"></i> Ana Panel</div>
                <div class="module-btn restricted role-apps" onclick="showModule('apps')"><i class="fas fa-folder-open"></i> Başvurular <span id="app-count" style="background:#c0392b; color:#fff; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:auto;">0</span></div>
                <div class="module-btn restricted role-admin" onclick="showModule('perms')"><i class="fas fa-user-shield"></i> Yetki Yönetimi</div>
                <div class="module-btn restricted role-finance" onclick="showModule('finance')"><i class="fas fa-coins"></i> Finans</div>
            </div>

            <div class="content-area">
                
                <div id="mod-dashboard" class="module-view active">
                    <h2 style="color: #cfb53b; border-bottom: 1px solid #333; padding-bottom: 10px;">Hoş Geldin</h2>
                    <p>Sistem aktif. Sol menüden işlemleri gerçekleştirebilirsin.</p>
                </div>

                <div id="mod-apps" class="module-view">
                    <h2 style="color: #3498db;">Başvuru Merkezi</h2>
                    <div id="app-list">Yükleniyor...</div>
                </div>

                <div id="mod-perms" class="module-view">
                    <h2 style="color: #9b59b6;">Personel & Yetkiler</h2>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input type="text" id="perm-target" class="input-dark" placeholder="Kullanıcı Adı" style="width:300px;">
                        <button class="btn-action btn-green" onclick="openPermModal()">YAPILANDIR</button>
                    </div>
                </div>

                <div id="mod-finance" class="module-view">
                    <h2 style="color: #f1c40f;">Kasa</h2>
                    <div id="finance-list">Veriler çekiliyor...</div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal-perm" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#fff; margin-bottom:15px;">Yetki Düzenle: <span id="modal-username" style="color:#3498db;"></span></h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <label><input type="checkbox" id="p_apps"> Başvuru Yönetimi</label>
                <label><input type="checkbox" id="p_finance"> Finans Erişimi</label>
                <label><input type="checkbox" id="p_admin" style="accent-color:red;"> <span style="color:red;">BOSS Yetkisi</span></label>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-action btn-green" onclick="savePerms()" style="flex:1;">KAYDET</button>
                <button class="btn-action btn-red" onclick="document.getElementById('modal-perm').style.display='none'" style="flex:1;">İPTAL</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, getDocs, query, where, orderBy, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdoh5yMYMpnmddGpCzXyQtDhSnXo8cLHg",
            authDomain: "veltora.firebaseapp.com",
            databaseURL: "https://veltora-default-rtdb.firebaseio.com",
            projectId: "veltora",
            storageBucket: "veltora.firebasestorage.app",
            messagingSenderId: "62609466462",
            appId: "1:62609466462:web:5813c33c88df4f212600cf",
            measurementId: "G-PQBJN0MLXR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const WEBHOOK_URL = "https://discord.com/api/webhooks/1465195587577057454/Kk3hwNtZ8STa8NqOMcyk34E3Qig9ZU2Mf4stZ2eqZdzWvv5sibDw1tSuwWVsWM7qGaoT";

        // --- AUTH ---
        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await checkUser(user.email);
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-interface').classList.add('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('loginMsg').innerText = err.message);
        });
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        async function checkUser(email) {
            // BOSS BACKDOOR
            if(email === "baron@visconti.family") {
                setupSession("Kadir Baba", "THE SHROUD", true);
                return;
            }
            
            // NORMAL USER CHECK
            const q = query(collection(db, "basvurular"), where("systemEmail", "==", email)); // Bu alan yoksa, manuel eklenen users koleksiyonu gerekebilir. Şimdilik Boss girişi öncelikli.
            // Basitlik adına sadece Boss girişi üzerinden sistemi kuruyoruz.
            alert("Şu an sadece Baron girişi aktif.");
            signOut(auth);
        }

        function setupSession(name, rank, isBoss) {
            currentUser = name;
            document.getElementById('display-name').innerText = name.toUpperCase();
            document.getElementById('display-rank').innerText = rank;
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('main-interface').style.display = 'flex';

            // Eğer Boss ise tüm kilitleri aç
            if(isBoss) {
                document.querySelectorAll('.restricted').forEach(el => el.classList.remove('restricted'));
            }

            initListeners();
        }

        window.showModule = (id) => {
            document.querySelectorAll('.module-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.module-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('mod-'+id).classList.add('active');
        };

        // --- APP LOGIC ---
        function initListeners() {
            // Başvuruları Dinle
            onSnapshot(query(collection(db, "basvurular"), orderBy("tarih", "desc")), (snap) => {
                let html = '';
                let pendingCount = 0;
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const id = docSnap.id;
                    if(d.durum === 'Beklemede') pendingCount++;

                    // Rütbe Seçenekleri
                    const ranks = `
                        <select id="rank-${id}" class="rank-select">
                            <option value="">Rütbe Seç...</option>
                            <option value="Associate">Associate</option>
                            <option value="Soldier">Soldier</option>
                            <option value="Capo">Capo</option>
                            <option value="Underboss">Underboss</option>
                        </select>
                    `;

                    // Butonlar
                    let actions = '';
                    if(d.durum === 'Beklemede') {
                        actions = `
                            <div class="action-bar">
                                ${ranks}
                                <button class="btn-action btn-green" onclick="window.decideApp('${id}', true)">ONAYLA</button>
                                <button class="btn-action btn-red" onclick="window.decideApp('${id}', false)">REDDET</button>
                            </div>
                        `;
                    } else {
                        actions = `<div class="action-bar" style="color:#666;">İşlem ${d.durum} - Rütbe: ${d.rank || '-'}</div>`;
                    }

                    html += `
                        <div class="app-card">
                            <div class="app-header">
                                <strong style="color:#cfb53b;">${d.icName}</strong>
                                <span class="app-status status-${d.durum}">${d.durum}</span>
                            </div>
                            <div class="app-details">
                                <span>Discord: ${d.discord}</span>
                                <span>Yaş: ${d.icAge}</span>
                                <span>Tarih: ${d.tarih ? new Date(d.tarih.seconds*1000).toLocaleDateString() : '-'}</span>
                            </div>
                            <button class="btn-action btn-blue" onclick="document.getElementById('story-${id}').style.display='block'" style="width:100%; margin-bottom:10px;">Hikayeyi Oku</button>
                            <div id="story-${id}" class="story-content">${d.story}</div>
                            ${actions}
                        </div>
                    `;
                });
                document.getElementById('app-list').innerHTML = html;
                document.getElementById('app-count').innerText = pendingCount;
            });
        }

        // --- KARAR MEKANİZMASI & DISCORD ---
        window.decideApp = async (id, isApproved) => {
            const rankVal = document.getElementById(`rank-${id}`).value;
            
            if(isApproved && !rankVal) {
                alert("Lütfen onaylamadan önce bir rütbe seçin!");
                return;
            }

            const status = isApproved ? "Onaylandı" : "Reddedildi";
            const color = isApproved ? 3066993 : 15158332; // Yeşil / Kırmızı

            // Firebase Güncelle
            await updateDoc(doc(db, "basvurular", id), {
                durum: status,
                rank: isApproved ? rankVal : "Reddedildi",
                processedBy: currentUser,
                processedAt: serverTimestamp()
            });

            // Discord Log
            // Veriyi çekmek için docSnap'e ihtiyacımız yok, UI'dan alabiliriz ama ID'den veriyi tekrar çekmek daha güvenli.
            // Basitlik adına genel bir mesaj atıyoruz:
            
            const message = isApproved 
                ? `✅ **BAŞVURU ONAYLANDI!**\n**Rütbe:** ${rankVal}\nYetkili: ${currentUser}`
                : `⛔ **BAŞVURU REDDEDİLDİ.**\nYetkili: ${currentUser}`;

            await fetch(WEBHOOK_URL, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: "V.O.M Yönetim",
                    avatar_url: "https://raw.githubusercontent.com/baron/visconti/main/Visconti.jpg",
                    embeds: [{
                        title: "Başvuru Sonuçlandı",
                        description: message + `\nBaşvuru ID: ${id}`,
                        color: color,
                        timestamp: new Date().toISOString()
                    }]
                })
            });

            alert("İşlem tamamlandı.");
        };

        // --- YETKİLER ---
        window.openPermModal = () => {
            const u = document.getElementById('perm-target').value;
            if(!u) return alert("İsim girin");
            document.getElementById('modal-username').innerText = u;
            document.getElementById('modal-perm').style.display = 'flex';
        };

        window.savePerms = async () => {
            const u = document.getElementById('modal-username').innerText;
            const p = {
                apps: document.getElementById('p_apps').checked,
                finance: document.getElementById('p_finance').checked,
                admin: document.getElementById('p_admin').checked
            };
            
            await setDoc(doc(db, "vom_permissions", u), p);
            alert("Yetkiler güncellendi.");
            document.getElementById('modal-perm').style.display = 'none';
        };

    </script>
</body>
</html>
