<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V.O.M | Visconti Ailesi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: #cfb53b; font-family: 'Cinzel', serif; margin-bottom: 20px;">V.O.M ACCESS</h2>
            <input type="email" id="email" class="input-dark" placeholder="Kimlik (@visconti.family)" style="margin-bottom: 10px;">
            <input type="password" id="password" class="input-dark" placeholder="Åžifre" style="margin-bottom: 20px;">
            <button class="btn-action btn-gold" id="btnLogin" style="width: 100%; padding: 12px;">SÄ°STEME GÄ°R</button>
            <p id="loginMsg" style="color: var(--red); margin-top: 10px; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div id="main-interface" class="hidden">
        <div class="top-bar">
            <div style="font-family: 'Share Tech Mono', monospace; color: #cfb53b;">
                <i class="fas fa-crown"></i> <span id="display-name">...</span> 
                <span style="color: #444;">|</span> 
                <span id="display-rank" style="color: #fff; font-weight:bold;">...</span>
            </div>
            <button class="btn-action btn-red" id="btnLogout">Ã‡IKIÅž</button>
        </div>

        <div class="workspace">
            <div class="sidebar">
                <div class="module-btn active" onclick="showModule('dashboard')"><i class="fas fa-home"></i> Ana Panel</div>
                <div class="module-btn restricted role-apps" onclick="showModule('apps')"><i class="fas fa-folder-open"></i> BaÅŸvurular <span id="app-count" style="background:#c0392b; color:#fff; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:auto;">0</span></div>
                <div class="module-btn restricted role-perms" onclick="showModule('perms')"><i class="fas fa-users-cog"></i> Personel & Yetkiler</div>
                
                <div class="module-btn restricted role-finance" onclick="showModule('finance')"><i class="fas fa-coins"></i> Kasa (Diamond)</div>
                <div class="module-btn restricted role-strategy" onclick="showModule('strategy')"><i class="fas fa-map-marked-alt"></i> BÃ¶lge & Ä°nÅŸaat</div>
                <div class="module-btn restricted role-intel" onclick="showModule('intel')"><i class="fas fa-user-secret"></i> Ä°stihbarat (Wraith)</div>
                <div class="module-btn restricted role-hitlist" onclick="showModule('hitlist')"><i class="fas fa-crosshairs"></i> Ä°nfaz Listesi</div>
                <div class="module-btn restricted role-diplo" onclick="showModule('diplo')"><i class="fas fa-handshake"></i> Diplomasi</div>
                <div class="module-btn restricted role-blacklist" onclick="showModule('blacklist')"><i class="fas fa-gavel"></i> Blacklist (Overseer)</div>
                <div class="module-btn restricted role-cyber" onclick="showModule('cyber')"><i class="fas fa-network-wired"></i> Siber AÄŸ (Oracle)</div>
                <div class="module-btn restricted role-clean" onclick="showModule('cleanup')"><i class="fas fa-biohazard"></i> Temizlik (Cleaner)</div>
                
                <div class="module-btn restricted role-discordban" onclick="showModule('discordban')"><i class="fab fa-discord"></i> Discord Ä°nfaz (Baron)</div>
            </div>

            <div class="content-area">
                
                <div id="mod-dashboard" class="module-view active">
                    <h2 style="color: #cfb53b; border-bottom: 1px solid #333; padding-bottom: 10px;">HoÅŸ Geldin</h2>
                    <p>Visconti Mainframe aktif. Sol menÃ¼den iÅŸlemleri gerÃ§ekleÅŸtirebilirsin.</p>
                </div>

                <div id="mod-apps" class="module-view">
                    <h2 style="color: #e91e63;">BaÅŸvuru Merkezi</h2>
                    <div id="app-list">YÃ¼kleniyor...</div>
                </div>

                <div id="mod-perms" class="module-view">
                    <h2 style="color: #9b59b6;">Aktif Personel</h2>
                    <div id="personnel-list-container">YÃ¼kleniyor...</div>
                </div>

                <div id="mod-finance" class="module-view">
                    <h2 style="color: #3498db;">Hazine</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="fin-desc" class="input-dark" placeholder="AÃ§Ä±klama">
                        <input type="number" id="fin-amount" class="input-dark" placeholder="Miktar">
                        <select id="fin-type" class="input-dark"><option>GELÄ°R</option><option>GÄ°DER</option></select>
                        <button class="btn-action btn-green" onclick="addFinance()">KAYDET</button>
                    </div>
                    <div id="list-finance"></div>
                </div>

                <div id="mod-strategy" class="module-view">
                    <h2 style="color: #2ecc71;">BÃ¶lge & Ä°nÅŸaat</h2>
                    <textarea id="strat-note" class="input-dark" rows="5" placeholder="Not..."></textarea>
                    <button class="btn-action btn-green" onclick="addNote('strategy', 'strat-note')">YAYINLA</button>
                    <div id="list-strategy" style="margin-top:20px;"></div>
                </div>

                <div id="mod-intel" class="module-view">
                    <h2 style="color: #bdc3c7;">Ä°stihbarat</h2>
                    <input type="text" id="intel-target" class="input-dark" placeholder="Hedef KiÅŸi/Kurum">
                    <textarea id="intel-info" class="input-dark" rows="3" placeholder="Bilgi..."></textarea>
                    <button class="btn-action btn-green" onclick="addIntel()">RAPORLA</button>
                    <div id="list-intel" style="margin-top:20px;"></div>
                </div>

                <div id="mod-hitlist" class="module-view">
                    <h2 style="color: #c0392b;">Ä°nfaz Listesi</h2>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="hit-target" class="input-dark" placeholder="Hedef AdÄ±">
                        <select id="hit-prio" class="input-dark"><option>DÃ¼ÅŸÃ¼k</option><option>YÃ¼ksek</option><option>ACÄ°L</option></select>
                        <button class="btn-action btn-red" onclick="addHit()">EKLE</button>
                    </div>
                    <div id="list-hitlist" style="margin-top:20px;"></div>
                </div>

                <div id="mod-diplo" class="module-view">
                    <h2 style="color: #e67e22;">Diplomasi</h2>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="diplo-gang" class="input-dark" placeholder="OluÅŸum AdÄ±">
                        <select id="diplo-status" class="input-dark"><option>Dost ðŸŸ¢</option><option>NÃ¶tr âšª</option><option>DÃ¼ÅŸman ðŸ”´</option></select>
                        <button class="btn-action btn-green" onclick="addDiplo()">GÃœNCELLE</button>
                    </div>
                    <div id="list-diplo" style="margin-top:20px;"></div>
                </div>

                <div id="mod-blacklist" class="module-view">
                    <h2 style="color: #95a5a6;">Kara Liste</h2>
                    <input type="text" id="bl-name" class="input-dark" placeholder="KiÅŸi AdÄ±">
                    <input type="text" id="bl-reason" class="input-dark" placeholder="Sebep / SuÃ§">
                    <button class="btn-action btn-red" onclick="addBlacklist()">SÄ°CÄ°LE Ä°ÅžLE</button>
                    <div id="list-blacklist" style="margin-top:20px;"></div>
                </div>

                <div id="mod-cyber" class="module-view">
                    <h2 style="color: #00bcd4;">Oracle Siber</h2>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <input type="text" id="cyber-target" class="input-dark" placeholder="IP / KiÅŸi">
                            <textarea id="cyber-info" class="input-dark" rows="3" placeholder="Bilgi..."></textarea>
                            <button class="btn-action btn-blue" onclick="addCyber()">GÄ°RÄ°Åž</button>
                        </div>
                        <div id="list-cyber" style="background:rgba(0,0,0,0.3); padding:10px; height:300px; overflow-y:auto;"></div>
                    </div>
                </div>

                <div id="mod-cleanup" class="module-view">
                    <h2 style="color: #7f8c8d;">Temizlik</h2>
                    <input type="text" id="clean-loc" class="input-dark" placeholder="Konum">
                    <button class="btn-action btn-red" onclick="addNote('cleanup', 'clean-loc')">EKÄ°P GÃ–NDER</button>
                    <div id="list-cleanup" style="margin-top:20px;"></div>
                </div>

                <div id="mod-discordban" class="module-view">
                    <h2 style="color: #5865F2; border-bottom: 1px solid #333; padding-bottom: 10px;">
                        <i class="fab fa-discord"></i> Discord Ä°nfaz Listesi
                    </h2>
                    <p style="color:#666; font-size:0.8rem; margin-bottom:15px;">
                        Buraya eklenen kiÅŸiler Discord sunucusundan yasaklanmalÄ±. <br>
                        <span style="color:var(--red);">UYARI: Bu listeden kaydÄ± sadece BARON silebilir.</span>
                    </p>

                    <div style="display:flex; gap:10px; margin-bottom: 20px;">
                        <input type="text" id="dban-id" class="input-dark" placeholder="Discord ID (Ã–rn: 123456789)">
                        <input type="text" id="dban-reason" class="input-dark" placeholder="Ä°nfaz Sebebi">
                        <button class="btn-action btn-red" onclick="addDiscordBan()">LÄ°STEYE AL</button>
                    </div>
                    
                    <div id="list-discordban" style="background:rgba(0,0,0,0.2); border:1px solid #333; padding:10px; min-height:200px; border-radius:5px;">
                        YÃ¼kleniyor...
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal-perm" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#fff; margin-bottom:15px;">Ã–zel Yetki: <span id="modal-username" style="color:#3498db;"></span></h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <label><input type="checkbox" id="p_apps"> BaÅŸvuru</label>
                <label><input type="checkbox" id="p_finance"> Kasa</label>
                <label><input type="checkbox" id="p_strategy"> Strateji</label>
                <label><input type="checkbox" id="p_cyber"> Siber</label>
                <label><input type="checkbox" id="p_clean"> Temizlik</label>
                <label><input type="checkbox" id="p_intel"> Ä°stihbarat</label>
                <label><input type="checkbox" id="p_hitlist"> Ä°nfaz</label>
                <label><input type="checkbox" id="p_diplo"> Diplomasi</label>
                <label><input type="checkbox" id="p_admin" style="accent-color:red;"> <span style="color:red;">BOSS (Full Yetki)</span></label>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-action btn-green" onclick="savePerms()" style="flex:1;">KAYDET</button>
                <button class="btn-action btn-red" onclick="document.getElementById('modal-perm').style.display='none'" style="flex:1;">Ä°PTAL</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, getDocs, query, where, orderBy, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdoh5yMYMpnmddGpCzXyQtDhSnXo8cLHg",
            authDomain: "veltora.firebaseapp.com",
            databaseURL: "https://veltora-default-rtdb.firebaseio.com",
            projectId: "veltora",
            storageBucket: "veltora.firebasestorage.app",
            messagingSenderId: "62609466462",
            appId: "1:62609466462:web:5813c33c88df4f212600cf",
            measurementId: "G-PQBJN0MLXR"
        };

        // --- UYGULAMALAR ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
        const secondaryAuth = getAuth(secondaryApp);

        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1465195587577057454/Kk3hwNtZ8STa8NqOMcyk34E3Qig9ZU2Mf4stZ2eqZdzWvv5sibDw1tSuwWVsWM7qGaoT";

        let currentUser = null;
        const RANK_LIST = ['THE SHROUD', 'THE DIAMOND', 'THE PRINCESS', 'THE ARCHITECT', 'BLOODLINE', 'OVERSEER', 'GRAVEDIGGER', 'WRAITH', 'ORACLE', 'HARBINGER', 'CADAVER', 'CLEANER', 'VISCONTI Aile Ãœyesi'];
        
        // STATIC PERMISSIONS (YENÄ° EKLENEN 'discordban' YETKÄ°SÄ° DAHÄ°L)
        const PERMISSIONS = {
            'THE SHROUD': ['all'], 
            'THE DIAMOND': ['finance', 'diplo', 'apps', 'strategy', 'discordban'],
            'THE PRINCESS': ['apps', 'diplo', 'perms', 'discordban'],
            'THE ARCHITECT': ['strategy', 'finance'],
            'BLOODLINE': ['diplo'],
            'OVERSEER': ['blacklist', 'intel', 'apps', 'discordban'],
            'GRAVEDIGGER': ['hitlist', 'clean'],
            'WRAITH': ['intel'],
            'ORACLE': ['cyber', 'intel'],
            'HARBINGER': ['diplo'],
            'CLEANER': ['clean'],
            'VISCONTI Aile Ãœyesi': []
        };

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) await checkUser(user.email);
            else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-interface').classList.add('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(e === "baron@visconti.family" && p === "Kadir59312er") {
                setupSession("Kadir Baba", "THE SHROUD", true);
                return;
            }
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('loginMsg').innerText = err.message);
        });
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        async function checkUser(email) {
            if(email === "baron@visconti.family") {
                setupSession("Kadir Baba", "THE SHROUD", true);
                return;
            }
            const q = query(collection(db, "basvurular"), where("systemEmail", "==", email));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const data = querySnapshot.docs[0].data();
                if(data.durum === "Kovuldu") {
                    alert("EriÅŸiminiz feshedildi.");
                    signOut(auth);
                } else {
                    setupSession(data.icName, data.rank, false);
                }
            } else {
                alert("Yetkisiz giriÅŸ.");
                signOut(auth);
            }
        }

        // --- KRÄ°TÄ°K GÃœNCELLEME: Ã–ZEL YETKÄ°LERÄ° OKUMA ---
        async function setupSession(name, rank, isBoss) {
            currentUser = name;
            document.getElementById('display-name').innerText = name.toUpperCase();
            document.getElementById('display-rank').innerText = rank;
            if(rank === 'THE SHROUD') document.getElementById('display-rank').style.color = 'var(--gold)';
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('main-interface').style.display = 'flex';

            document.querySelectorAll('.restricted').forEach(el => el.classList.remove('active-flex'));
            
            // 1. Ã–ZEL YETKÄ°LERÄ° FIREBASE'DEN Ã‡EK
            let customPerms = {};
            try {
                const permSnap = await getDoc(doc(db, "vom_permissions", name));
                if (permSnap.exists()) {
                    customPerms = permSnap.data();
                }
            } catch (e) { console.log("Yetki okuma hatasÄ± veya yetki yok", e); }

            // 2. BOSS KONTROLÃœ (RÃ¼tbe VEYA Ã–zel Yetki)
            const effectiveBoss = isBoss || customPerms.admin === true || rank === 'THE SHROUD';

            // 3. MODÃœLLERÄ° AÃ‡MA MANTIÄžI
            const staticPerms = PERMISSIONS[rank] || [];

            // Helper: Bir modÃ¼lÃ¼ aÃ§ma
            const show = (selector) => document.querySelectorAll(selector).forEach(el => el.style.display = 'flex');

            if (effectiveBoss) {
                document.querySelectorAll('.restricted').forEach(el => el.style.display = 'flex');
            } else {
                // RÃ¼tbe BazlÄ±
                staticPerms.forEach(p => show(`.role-${p}`));
                
                // Ã–zel Yetki BazlÄ± (Manuel Eklenenler)
                if(customPerms.apps) show('.role-apps');
                if(customPerms.finance) show('.role-finance');
                if(customPerms.strategy) show('.role-strategy');
                if(customPerms.cyber) show('.role-cyber');
                if(customPerms.clean) show('.role-clean');
                if(customPerms.intel) show('.role-intel');
                if(customPerms.hitlist) show('.role-hitlist');
                if(customPerms.diplo) show('.role-diplo');
            }

            // 4. LÄ°STENERLARI BAÅžLAT (Ã–ZEL YETKÄ°LERÄ° GÃ–NDERÄ°YORUZ)
            initListeners(rank, effectiveBoss, customPerms);
        }

        // --- VERÄ° OKUMA (Ã–ZEL YETKÄ° DESTEKLÄ°) ---
        function initListeners(rank, isBoss, customPerms) {
            const perms = PERMISSIONS[rank] || [];
            
            // Bu fonksiyon: RÃ¼tbe yetkisi VARSA veya Ã–zel Yetki VARSA true dÃ¶ner
            const canSee = (mod) => isBoss || perms.includes(mod) || perms.includes('all') || customPerms[mod] === true;

            if(canSee('apps') || canSee('perms')) {
                onSnapshot(query(collection(db, "basvurular"), orderBy("tarih", "desc")), (snap) => {
                    let htmlApps = '', htmlPersonnel = '', pendingCount = 0;
                    snap.forEach(d => {
                        const data = d.data();
                        const id = d.id;
                        if(data.durum === 'Beklemede') {
                            pendingCount++;
                            htmlApps += `<div class="app-card"><div class="app-header"><strong style="color:#cfb53b;">${data.icName}</strong><span class="app-status status-Beklemede">Beklemede</span></div>
                            <div class="app-details"><span>DC: ${data.discord}</span><span>YaÅŸ: ${data.icAge}</span><button class="btn-action btn-blue" onclick="document.getElementById('story-${id}').style.display='block'">Hikaye</button></div>
                            <div id="story-${id}" class="story-content">${data.story}</div>
                            <div class="action-bar"><select id="rank-${id}" class="rank-select"><option value="">SeÃ§...</option><option value="VISCONTI Aile Ãœyesi">Ãœye</option><option value="THE DIAMOND">Diamond</option></select>
                            <button class="btn-action btn-green" onclick="window.decideApp('${id}', true)">ONAYLA</button><button class="btn-action btn-red" onclick="window.decideApp('${id}', false)">REDDET</button></div></div>`;
                        } else if(data.durum === 'OnaylandÄ±') {
                            const rankOpts = RANK_LIST.map(r => `<option value="${r}" ${r===data.rank?'selected':''}>${r}</option>`).join('');
                            htmlPersonnel += `<div class="list-item"><div class="list-content"><span class="list-user">${data.icName}</span>
                            <select id="update-rank-${id}" class="rank-updater">${rankOpts}</select>
                            <button class="btn-action btn-green" onclick="updateUserRank('${id}')"><i class="fas fa-save"></i></button></div>
                            <div style="display:flex; gap:5px;"><button class="btn-action btn-blue" onclick="openPermModal('${data.icName}')">YETKÄ°</button>
                            <button class="btn-action btn-red" onclick="kickUser('${id}', '${data.icName}')">KOV</button></div></div>`;
                        }
                    });
                    if(canSee('apps')) {
                        document.getElementById('app-list').innerHTML = htmlApps || 'Bekleyen yok.';
                        document.getElementById('app-count').innerText = pendingCount;
                    }
                    if(canSee('perms')) { 
                        document.getElementById('personnel-list-container').innerHTML = htmlPersonnel || 'Personel yok.';
                    }
                });
            }
            if(canSee('finance')) listenSimple('vom_finance', 'list-finance');
            if(canSee('strategy')) listenSimple('vom_strategy', 'list-strategy');
            if(canSee('cyber')) listenSimple('vom_cyber', 'list-cyber');
            if(canSee('clean')) listenSimple('vom_cleanup', 'list-cleanup');
            if(canSee('intel')) listenSimple('vom_intel', 'list-intel');
            if(canSee('diplo')) listenSimple('vom_diplo', 'list-diplo');
            if(canSee('hitlist')) listenSimple('vom_hitlist', 'list-hitlist');
            if(canSee('blacklist')) listenSimple('vom_blacklist', 'list-blacklist');
            
            // YENÄ° EKLENEN LÄ°STENER
            if(canSee('discordban')) listenDiscordBan();
        }

        function listenSimple(col, elId) {
            onSnapshot(query(collection(db, col), orderBy("date", "desc")), (snap) => {
                let h = '';
                snap.forEach(d => {
                    const x = d.data();
                    let txt = x.info || x.desc;
                    if(x.amount) txt += ` (${x.amount}$) [${x.type}]`;
                    h += `<div class="list-item"><div class="list-content"><span class="list-user">${x.user}:</span> ${txt}</div><button class="btn-delete" onclick="deleteItem('${col}', '${d.id}')"><i class="fas fa-trash"></i></button></div>`;
                });
                document.getElementById(elId).innerHTML = h || '<span style="color:#444;font-size:0.8rem;">Veri yok.</span>';
            });
        }

        // --- YENÄ° EKLENEN DISCORD BAN FONKSÄ°YONLARI ---
        function listenDiscordBan() {
            onSnapshot(query(collection(db, "vom_discord_ban"), orderBy("date", "desc")), (snap) => {
                let h = '';
                snap.forEach(d => {
                    const x = d.data();
                    // Silme butonu herkese gÃ¶rÃ¼nÃ¼r ama sadece Baron'da Ã§alÄ±ÅŸÄ±r.
                    h += `<div class="list-item" style="border-left: 3px solid #5865F2;">
                            <div class="list-content">
                                <span class="list-user" style="color:#5865F2;">${x.user}:</span> 
                                <span style="color:#fff;">${x.info}</span>
                            </div>
                            <button class="btn-delete" style="border-color:#5865F2; color:#5865F2;" onclick="deleteDiscordBan('${d.id}')">
                                <i class="fas fa-skull"></i> KALDIR
                            </button>
                          </div>`;
                });
                document.getElementById('list-discordban').innerHTML = h || '<span style="color:#444;">Temiz.</span>';
            });
        }

        window.addDiscordBan = async () => {
            const id = document.getElementById('dban-id').value;
            const reason = document.getElementById('dban-reason').value;
            if(!id || !reason) return alert("ID ve Sebep girilmeli.");
            await addDoc(collection(db, "vom_discord_ban"), { info: `ID: ${id} | SEBEP: ${reason}`, user: currentUser, date: serverTimestamp() });
            document.getElementById('dban-id').value = "";
            document.getElementById('dban-reason').value = "";
        };

        window.deleteDiscordBan = async (docId) => {
            // SADECE BARON (Kadir Baba) SÄ°LEBÄ°LÄ°R
            if (currentUser !== "Kadir Baba") {
                alert("â›” BU LÄ°STEDEN SÄ°LME Ä°ÅžLEMÄ°NÄ° SADECE BARON YAPABÄ°LÄ°R!");
                return;
            }
            if(confirm("Bu kiÅŸi Discord infaz listesinden kaldÄ±rÄ±lsÄ±n mÄ±?")) {
                await deleteDoc(doc(db, "vom_discord_ban", docId));
                alert("KiÅŸi listeden silindi.");
            }
        };

        // --- DÄ°ÄžER MODÃœL FONKSÄ°YONLARI ---
        window.showModule = (id) => {
            document.querySelectorAll('.module-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.module-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('mod-'+id).classList.add('active');
        };

        window.deleteItem = async (col, id) => { if(confirm("Silinsin mi?")) await deleteDoc(doc(db, col, id)); };
        window.updateUserRank = async (id) => { const r = document.getElementById(`update-rank-${id}`).value; await updateDoc(doc(db, "basvurular", id), { rank: r }); alert("GÃ¼ncellendi."); };
        window.kickUser = async (id, n) => { if(confirm(`${n} kovulsun mu?`)) { await updateDoc(doc(db, "basvurular", id), { durum: "Kovuldu", rank: "Kovuldu", systemEmail: null, systemPassword: null }); await fetch(DISCORD_WEBHOOK_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ content: `âš ï¸ **${n} KOVULDU!**` }) }); alert("Kovuldu."); } };
        
        window.addFinance = async () => { const d=document.getElementById('fin-desc').value; const a=document.getElementById('fin-amount').value; const t=document.getElementById('fin-type').value; if(d) await addDoc(collection(db, "vom_finance"), { desc:d, amount:a, type:t, user:currentUser, date:serverTimestamp() }); };
        window.addNote = async (type, id) => { const v=document.getElementById(id).value; if(v) await addDoc(collection(db, `vom_${type}`), { info:v, user:currentUser, date:serverTimestamp() }); document.getElementById(id).value = ""; };
        window.addCyber = async () => { const t=document.getElementById('cyber-target').value; const i=document.getElementById('cyber-info').value; if(t) await addDoc(collection(db, "vom_cyber"), { info:`HEDEF: ${t} | ${i}`, user:currentUser, date:serverTimestamp() }); };
        window.addIntel = async () => { const t=document.getElementById('intel-target').value; const i=document.getElementById('intel-info').value; if(t) await addDoc(collection(db, "vom_intel"), { info:`HEDEF: ${t} | ${i}`, user:currentUser, date:serverTimestamp() }); };
        window.addDiplo = async () => { const g=document.getElementById('diplo-gang').value; const s=document.getElementById('diplo-status').value; if(g) await addDoc(collection(db, "vom_diplo"), { info:`OLUÅžUM: ${g} | DURUM: ${s}`, user:currentUser, date:serverTimestamp() }); };
        window.addHit = async () => { const t=document.getElementById('hit-target').value; const p=document.getElementById('hit-prio').value; if(t) await addDoc(collection(db, "vom_hitlist"), { info:`HEDEF: ${t} | Ã–NCELÄ°K: ${p}`, user:currentUser, date:serverTimestamp() }); };
        window.addBlacklist = async () => { const n=document.getElementById('bl-name').value; const r=document.getElementById('bl-reason').value; if(n) await addDoc(collection(db, "vom_blacklist"), { info:`KÄ°ÅžÄ°: ${n} | SUÃ‡: ${r}`, user:currentUser, date:serverTimestamp() }); };

        window.decideApp = async (id, isApproved) => {
            const rankVal = document.getElementById(`rank-${id}`).value;
            if(isApproved && !rankVal) return alert("RÃ¼tbe seÃ§!");
            
            const docRef = doc(db, "basvurular", id);
            const docSnap = await getDoc(docRef);
            const u = docSnap.data();
            
            let upd = { durum: isApproved ? "OnaylandÄ±" : "Reddedildi", processedAt: serverTimestamp() };
            let discordMsg = "", colorCode = 0;

            if(isApproved) {
                upd.rank = rankVal;
                const sysEmail = u.icName.toLowerCase().replace(/\s+/g, '.') + "@visconti.family";
                const sysPass = Math.random().toString(36).slice(-8);
                upd.systemEmail = sysEmail;
                upd.systemPassword = sysPass;

                try {
                    await createUserWithEmailAndPassword(secondaryAuth, sysEmail, sysPass);
                    secondaryAuth.signOut();
                } catch(e) { console.error("Auth kaydÄ± yapÄ±lamadÄ± (Sadece DB)"); }

                colorCode = 3066993;
                discordMsg = `âœ… **KABUL EDÄ°LDÄ°!**\n\nðŸ‘¤ **KiÅŸi:** ${u.icName}\nðŸ”° **RÃ¼tbe:** ${rankVal}\n\nðŸ”‘ **GiriÅŸ:**\nID: \`${sysEmail}\`\nÅžifre: \`${sysPass}\``;
            } else {
                upd.rank = "Red";
                colorCode = 15158332;
                discordMsg = `â›” **REDDEDÄ°LDÄ°.**\n\nðŸ‘¤ **KiÅŸi:** ${u.icName}`;
            }

            await updateDoc(docRef, upd);
            
            await fetch(DISCORD_WEBHOOK_URL, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: "V.O.M YÃ¶netim",
                    avatar_url: "https://raw.githubusercontent.com/baron/visconti/main/Visconti.jpg",
                    embeds: [{ title: "BaÅŸvuru Sonucu", description: discordMsg, color: colorCode, timestamp: new Date().toISOString() }]
                })
            });
            alert("Ä°ÅŸlem tamam.");
        };

        window.openPermModal = (u) => { document.getElementById('modal-username').innerText = u; document.getElementById('modal-perm').style.display = 'flex'; };
        window.savePerms = async () => {
            const u = document.getElementById('modal-username').innerText;
            const p = { 
                apps: document.getElementById('p_apps').checked, finance: document.getElementById('p_finance').checked, strategy: document.getElementById('p_strategy').checked,
                cyber: document.getElementById('p_cyber').checked, clean: document.getElementById('p_clean').checked, intel: document.getElementById('p_intel').checked,
                hitlist: document.getElementById('p_hitlist').checked, diplo: document.getElementById('p_diplo').checked, admin: document.getElementById('p_admin').checked
            };
            await setDoc(doc(db, "vom_permissions", u), p);
            alert("Yetkiler gÃ¼ncellendi.");
            document.getElementById('modal-perm').style.display = 'none';
        };
    </script>
</body>
</html>
