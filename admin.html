<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V.O.M | Visconti Ailesi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: #cfb53b; font-family: 'Cinzel', serif; margin-bottom: 20px;">V.O.M ACCESS</h2>
            <input type="email" id="email" class="input-dark" placeholder="Kimlik (@visconti.family)" style="margin-bottom: 10px;">
            <input type="password" id="password" class="input-dark" placeholder="Åžifre" style="margin-bottom: 20px;">
            <button class="btn-action btn-gold" id="btnLogin" style="width: 100%; padding: 12px;">SÄ°STEME GÄ°R</button>
            <p id="loginMsg" style="color: var(--red); margin-top: 10px; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div id="main-interface" class="hidden">
        <div class="top-bar">
            <div style="font-family: 'Share Tech Mono', monospace; color: #cfb53b;">
                <i class="fas fa-crown"></i> <span id="display-name">...</span> 
                <span style="color: #444;">|</span> 
                <span id="display-rank" style="color: #fff; font-weight:bold;">...</span>
            </div>
            <button class="btn-action btn-red" id="btnLogout">Ã‡IKIÅž</button>
        </div>

        <div class="workspace">
            <div class="sidebar">
                <div class="module-btn active" onclick="showModule('dashboard')"><i class="fas fa-home"></i> Ana Panel</div>
                <div class="module-btn restricted role-apps" onclick="showModule('apps')"><i class="fas fa-folder-open"></i> BaÅŸvurular <span id="app-count" style="background:#c0392b; color:#fff; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:auto;">0</span></div>
                <div class="module-btn restricted role-perms" onclick="showModule('perms')"><i class="fas fa-users-cog"></i> Personel & Yetkiler</div>
                
                <div class="module-btn restricted role-finance" onclick="showModule('finance')"><i class="fas fa-coins"></i> Kasa (Diamond)</div>
                <div class="module-btn restricted role-diplo" onclick="showModule('diplo')"><i class="fas fa-handshake"></i> Diplomasi</div>
                <div class="module-btn restricted role-strategy" onclick="showModule('strategy')"><i class="fas fa-map-marked-alt"></i> BÃ¶lge & Ä°nÅŸaat</div>
                <div class="module-btn restricted role-cyber" onclick="showModule('cyber')"><i class="fas fa-network-wired"></i> Siber AÄŸ (Oracle)</div>
                <div class="module-btn restricted role-intel" onclick="showModule('intel')"><i class="fas fa-user-secret"></i> Ä°stihbarat (Wraith)</div>
                <div class="module-btn restricted role-hitlist" onclick="showModule('hitlist')"><i class="fas fa-crosshairs"></i> Ä°nfaz Listesi</div>
                <div class="module-btn restricted role-blacklist" onclick="showModule('blacklist')"><i class="fas fa-gavel"></i> Blacklist (Overseer)</div>
                <div class="module-btn restricted role-clean" onclick="showModule('cleanup')"><i class="fas fa-biohazard"></i> Temizlik (Cleaner)</div>
            </div>

            <div class="content-area">
                
                <div id="mod-dashboard" class="module-view active">
                    <h2 style="color: #cfb53b; border-bottom: 1px solid #333; padding-bottom: 10px;">HoÅŸ Geldin</h2>
                    <p>Visconti Mainframe aktif. Sol menÃ¼den iÅŸlemleri gerÃ§ekleÅŸtirebilirsin.</p>
                </div>

                <div id="mod-apps" class="module-view">
                    <h2 style="color: #e91e63;">BaÅŸvuru Merkezi</h2>
                    <div id="app-list">YÃ¼kleniyor...</div>
                </div>

                <div id="mod-perms" class="module-view">
                    <h2 style="color: #9b59b6;">Aktif Personel</h2>
                    <div id="personnel-list-container">YÃ¼kleniyor...</div>
                </div>

                <div id="mod-finance" class="module-view">
                    <h2 style="color: #3498db;">Hazine</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="fin-desc" class="input-dark" placeholder="AÃ§Ä±klama">
                        <input type="number" id="fin-amount" class="input-dark" placeholder="Miktar">
                        <select id="fin-type" class="input-dark"><option>GELÄ°R</option><option>GÄ°DER</option></select>
                        <button class="btn-action btn-green" onclick="addFinance()">KAYDET</button>
                    </div>
                    <div id="list-finance"></div>
                </div>

                <div id="mod-strategy" class="module-view">
                    <h2 style="color: #2ecc71;">BÃ¶lge & Ä°nÅŸaat</h2>
                    <textarea id="strat-note" class="input-dark" rows="5" placeholder="Not..."></textarea>
                    <button class="btn-action btn-green" onclick="addNote('strategy', 'strat-note')">YAYINLA</button>
                    <div id="list-strategy" style="margin-top:20px;"></div>
                </div>

                <div id="mod-cyber" class="module-view">
                    <h2 style="color: #00bcd4;">Oracle Siber</h2>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <input type="text" id="cyber-target" class="input-dark" placeholder="IP / KiÅŸi">
                            <textarea id="cyber-info" class="input-dark" rows="3" placeholder="Bilgi..."></textarea>
                            <button class="btn-action btn-blue" onclick="addCyber()">VERÄ° GÄ°RÄ°ÅžÄ°</button>
                        </div>
                        <div id="list-cyber" style="background:rgba(0,0,0,0.3); padding:10px; height:300px; overflow-y:auto;"></div>
                    </div>
                </div>

                <div id="mod-intel" class="module-view">
                    <h2 style="color: #bdc3c7;">Ä°stihbarat (Wraith)</h2>
                    <input type="text" id="intel-target" class="input-dark" placeholder="Hedef KiÅŸi/Kurum">
                    <textarea id="intel-info" class="input-dark" rows="3" placeholder="Toplanan Bilgi..."></textarea>
                    <button class="btn-action btn-green" onclick="addIntel()">RAPORLA</button>
                    <div id="list-intel" style="margin-top:20px;"></div>
                </div>

                <div id="mod-diplo" class="module-view">
                    <h2 style="color: #e67e22;">Diplomasi</h2>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="diplo-gang" class="input-dark" placeholder="OluÅŸum AdÄ±">
                        <select id="diplo-status" class="input-dark">
                            <option value="Dost ðŸŸ¢">Dost</option>
                            <option value="NÃ¶tr âšª">NÃ¶tr</option>
                            <option value="DÃ¼ÅŸman ðŸ”´">DÃ¼ÅŸman</option>
                        </select>
                        <button class="btn-action btn-green" onclick="addDiplo()">GÃœNCELLE</button>
                    </div>
                    <div id="list-diplo" style="margin-top:20px;"></div>
                </div>

                <div id="mod-hitlist" class="module-view">
                    <h2 style="color: #c0392b;">Ä°nfaz Listesi</h2>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="hit-target" class="input-dark" placeholder="Hedef AdÄ±">
                        <select id="hit-prio" class="input-dark">
                            <option value="DÃ¼ÅŸÃ¼k">DÃ¼ÅŸÃ¼k Ã–ncelik</option>
                            <option value="YÃ¼ksek">YÃ¼ksek Ã–ncelik</option>
                            <option value="ACÄ°L">ACÄ°L Ä°NFAZ</option>
                        </select>
                        <button class="btn-action btn-red" onclick="addHit()">LÄ°STEYE EKLE</button>
                    </div>
                    <div id="list-hitlist" style="margin-top:20px;"></div>
                </div>

                <div id="mod-blacklist" class="module-view">
                    <h2 style="color: #95a5a6;">Kara Liste (Overseer)</h2>
                    <input type="text" id="bl-name" class="input-dark" placeholder="KiÅŸi AdÄ±">
                    <input type="text" id="bl-reason" class="input-dark" placeholder="Sebep / SuÃ§">
                    <button class="btn-action btn-red" onclick="addBlacklist()">SÄ°CÄ°LE Ä°ÅžLE</button>
                    <div id="list-blacklist" style="margin-top:20px;"></div>
                </div>

                <div id="mod-cleanup" class="module-view">
                    <h2 style="color: #7f8c8d;">Temizlik</h2>
                    <input type="text" id="clean-loc" class="input-dark" placeholder="Konum">
                    <button class="btn-action btn-red" onclick="addNote('cleanup', 'clean-loc')">EKÄ°P GÃ–NDER</button>
                    <div id="list-cleanup" style="margin-top:20px;"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal-perm" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#fff; margin-bottom:15px;">Yetki Ver: <span id="modal-username" style="color:#3498db;"></span></h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <label><input type="checkbox" id="p_apps"> BaÅŸvuru</label>
                <label><input type="checkbox" id="p_finance"> Kasa</label>
                <label><input type="checkbox" id="p_strategy"> Strateji</label>
                <label><input type="checkbox" id="p_cyber"> Siber</label>
                <label><input type="checkbox" id="p_clean"> Temizlik</label>
                <label><input type="checkbox" id="p_intel"> Ä°stihbarat</label>
                <label><input type="checkbox" id="p_hitlist"> Ä°nfaz</label>
                <label><input type="checkbox" id="p_diplo"> Diplomasi</label>
                <label><input type="checkbox" id="p_admin" style="accent-color:red;"> <span style="color:red;">BOSS</span></label>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-action btn-green" onclick="savePerms()" style="flex:1;">KAYDET</button>
                <button class="btn-action btn-red" onclick="document.getElementById('modal-perm').style.display='none'" style="flex:1;">Ä°PTAL</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, getDocs, query, where, orderBy, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdoh5yMYMpnmddGpCzXyQtDhSnXo8cLHg",
            authDomain: "veltora.firebaseapp.com",
            databaseURL: "https://veltora-default-rtdb.firebaseio.com",
            projectId: "veltora",
            storageBucket: "veltora.firebasestorage.app",
            messagingSenderId: "62609466462",
            appId: "1:62609466462:web:5813c33c88df4f212600cf",
            measurementId: "G-PQBJN0MLXR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;

        // ROL TANIMLARI
        const PERMISSIONS = {
            'THE SHROUD': ['all'], 
            'THE DIAMOND': ['finance', 'diplo', 'apps', 'strategy'],
            'THE PRINCESS': ['apps', 'diplo', 'perms'],
            'THE ARCHITECT': ['strategy', 'finance'],
            'BLOODLINE': ['diplo'],
            'OVERSEER': ['blacklist', 'intel', 'apps'],
            'GRAVEDIGGER': ['hitlist', 'clean'],
            'WRAITH': ['intel'],
            'ORACLE': ['cyber', 'intel'],
            'HARBINGER': ['diplo'],
            'CLEANER': ['clean'],
            'VISCONTI Aile Ãœyesi': []
        };

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) await checkUser(user.email);
            else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-interface').classList.add('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('loginMsg').innerText = err.message);
        });
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        async function checkUser(email) {
            if(email === "baron@visconti.family") {
                setupSession("Kadir Baba", "THE SHROUD", true);
                return;
            }
            alert("Sadece Baron giriÅŸi aktif. (baron@visconti.family)");
            signOut(auth);
        }

        function setupSession(name, rank, isBoss) {
            currentUser = name;
            document.getElementById('display-name').innerText = name.toUpperCase();
            document.getElementById('display-rank').innerText = rank;
            
            if(rank === 'THE SHROUD') document.getElementById('display-rank').style.color = 'var(--gold)';
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('main-interface').style.display = 'flex';

            if(rank === 'THE SHROUD') {
                document.querySelectorAll('.restricted').forEach(el => el.classList.remove('restricted'));
            } else {
                (PERMISSIONS[rank] || []).forEach(p => {
                    document.querySelectorAll(`.role-${p}`).forEach(el => el.classList.remove('restricted'));
                });
            }
            initListeners();
        }

        window.showModule = (id) => {
            document.querySelectorAll('.module-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.module-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('mod-'+id).classList.add('active');
        };

        // --- GLOBAL SÄ°LME FONKSÄ°YONU ---
        window.deleteItem = async (collectionName, docId) => {
            if(confirm("Bu kaydÄ± kalÄ±cÄ± olarak silmek istediÄŸine emin misin?")) {
                await deleteDoc(doc(db, collectionName, docId));
            }
        }

        // --- DATA EKLEME FONKSÄ°YONLARI ---
        window.addFinance = async () => {
            const desc = document.getElementById('fin-desc').value;
            const am = document.getElementById('fin-amount').value;
            const type = document.getElementById('fin-type').value;
            if(!desc) return;
            await addDoc(collection(db, "vom_finance"), { desc, amount: am, type, user: currentUser, date: serverTimestamp() });
        };

        window.addNote = async (type, inputId) => {
            const info = document.getElementById(inputId).value;
            if(!info) return;
            await addDoc(collection(db, `vom_${type}`), { info, user: currentUser, date: serverTimestamp() });
            document.getElementById(inputId).value = "";
        };

        window.addCyber = async () => {
            const target = document.getElementById('cyber-target').value;
            const info = document.getElementById('cyber-info').value;
            if(!target) return;
            await addDoc(collection(db, "vom_cyber"), { info: `HEDEF: ${target} | ${info}`, user: currentUser, date: serverTimestamp() });
        };

        // YENÄ° EKLEME FONKSÄ°YONLARI
        window.addIntel = async () => {
            const target = document.getElementById('intel-target').value;
            const info = document.getElementById('intel-info').value;
            if(!target) return;
            await addDoc(collection(db, "vom_intel"), { info: `HEDEF: ${target} | BÄ°LGÄ°: ${info}`, user: currentUser, date: serverTimestamp() });
            document.getElementById('intel-target').value = ""; document.getElementById('intel-info').value = "";
        };

        window.addDiplo = async () => {
            const gang = document.getElementById('diplo-gang').value;
            const status = document.getElementById('diplo-status').value;
            if(!gang) return;
            await addDoc(collection(db, "vom_diplo"), { info: `OLUÅžUM: ${gang} | DURUM: ${status}`, user: currentUser, date: serverTimestamp() });
        };

        window.addHit = async () => {
            const target = document.getElementById('hit-target').value;
            const prio = document.getElementById('hit-prio').value;
            if(!target) return;
            await addDoc(collection(db, "vom_hitlist"), { info: `HEDEF: ${target} | Ã–NCELÄ°K: ${prio}`, user: currentUser, date: serverTimestamp() });
        };

        window.addBlacklist = async () => {
            const name = document.getElementById('bl-name').value;
            const reason = document.getElementById('bl-reason').value;
            if(!name) return;
            await addDoc(collection(db, "vom_blacklist"), { info: `KÄ°ÅžÄ°: ${name} | SUÃ‡: ${reason}`, user: currentUser, date: serverTimestamp() });
        };

        // --- LÄ°STENERLAR ---
        function initListeners() {
            // BAÅžVURULAR & PERSONEL
            onSnapshot(query(collection(db, "basvurular"), orderBy("tarih", "desc")), (snap) => {
                let htmlApps = '', htmlPersonnel = '', pendingCount = 0;
                snap.forEach(d => {
                    const data = d.data();
                    const id = d.id;
                    if(data.durum === 'Beklemede') {
                        pendingCount++;
                        // BaÅŸvuru HTML (AynÄ± kalÄ±yor)
                        htmlApps += `<div class="app-card"><div class="app-header"><strong style="color:#cfb53b;">${data.icName}</strong><span class="app-status status-Beklemede">Beklemede</span></div>
                        <div class="app-details"><span>DC: ${data.discord}</span><span>YaÅŸ: ${data.icAge}</span><button class="btn-action btn-blue" onclick="document.getElementById('story-${id}').style.display='block'">Hikaye</button></div>
                        <div id="story-${id}" class="story-content">${data.story}</div>
                        <div class="action-bar"><select id="rank-${id}" class="rank-select"><option value="">SeÃ§...</option><option value="VISCONTI Aile Ãœyesi">Ãœye</option><option value="THE DIAMOND">Diamond</option></select>
                        <button class="btn-action btn-green" onclick="window.decideApp('${id}', true)">ONAYLA</button><button class="btn-action btn-red" onclick="window.decideApp('${id}', false)">REDDET</button></div></div>`;
                    } else if(data.durum === 'OnaylandÄ±') {
                        htmlPersonnel += `<div class="list-item"><div class="list-content"><span class="list-user">${data.icName}</span> ${data.rank}</div><button class="btn-action btn-blue" onclick="openPermModal('${data.icName}')">YETKÄ°</button></div>`;
                    }
                });
                document.getElementById('app-list').innerHTML = htmlApps || 'Bekleyen yok.';
                document.getElementById('app-count').innerText = pendingCount;
                document.getElementById('personnel-list-container').innerHTML = htmlPersonnel || 'Personel yok.';
            });

            // MODÃœL LÄ°STELERÄ° (HEPSÄ° SÄ°LME BUTONLU)
            listenSimple('vom_finance', 'list-finance');
            listenSimple('vom_strategy', 'list-strategy');
            listenSimple('vom_cyber', 'list-cyber');
            listenSimple('vom_cleanup', 'list-cleanup');
            listenSimple('vom_intel', 'list-intel');
            listenSimple('vom_diplo', 'list-diplo');
            listenSimple('vom_hitlist', 'list-hitlist');
            listenSimple('vom_blacklist', 'list-blacklist');
        }

        function listenSimple(collName, elId) {
            onSnapshot(query(collection(db, collName), orderBy("date", "desc")), (snap) => {
                let h = '';
                snap.forEach(d => {
                    const x = d.data();
                    const id = d.id;
                    let content = x.info || x.desc;
                    if(x.amount) content += ` (${x.amount}$) [${x.type}]`;
                    
                    h += `
                        <div class="list-item">
                            <div class="list-content">
                                <span class="list-user">${x.user}:</span> ${content}
                            </div>
                            <button class="btn-delete" onclick="deleteItem('${collName}', '${id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                });
                document.getElementById(elId).innerHTML = h || '<span style="color:#444; font-size:0.8rem;">KayÄ±t yok.</span>';
            });
        }

        // BaÅŸvuru Karar Fonksiyonu
        window.decideApp = async (id, isApproved) => {
            const rankVal = document.getElementById(`rank-${id}`).value;
            if(isApproved && !rankVal) { alert("RÃ¼tbe seÃ§in!"); return; }
            await updateDoc(doc(db, "basvurular", id), { durum: isApproved ? "OnaylandÄ±" : "Reddedildi", rank: isApproved ? rankVal : "Red", processedAt: serverTimestamp() });
        };

        // Yetki Modal
        window.openPermModal = (u) => { document.getElementById('modal-username').innerText = u; document.getElementById('modal-perm').style.display = 'flex'; };
        window.savePerms = async () => {
            const u = document.getElementById('modal-username').innerText;
            const p = { 
                apps: document.getElementById('p_apps').checked, 
                finance: document.getElementById('p_finance').checked,
                strategy: document.getElementById('p_strategy').checked,
                cyber: document.getElementById('p_cyber').checked,
                clean: document.getElementById('p_clean').checked,
                intel: document.getElementById('p_intel').checked,
                hitlist: document.getElementById('p_hitlist').checked,
                diplo: document.getElementById('p_diplo').checked,
                admin: document.getElementById('p_admin').checked
            };
            await setDoc(doc(db, "vom_permissions", u), p);
            alert("Yetkiler gÃ¼ncellendi.");
            document.getElementById('modal-perm').style.display = 'none';
        };
    </script>
</body>
</html>
