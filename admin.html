<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visconti Operations Mainframe</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="admin-page">

    <div id="login-screen">
        <div class="login-box">
            <img src="Visconti.jpg" width="100" style="border-radius: 50%; border: 2px solid var(--gold); margin-bottom: 20px;">
            <h2 style="color: var(--gold);">V.O.M ACCESS</h2>
            <p style="margin-bottom: 20px; font-size: 0.8rem; color: #666;">Visconti Operations Mainframe</p>
            <input type="email" id="email" class="login-input" placeholder="Sistem Kimliği (@visconti.family)">
            <input type="password" id="password" class="login-input" placeholder="Erişim Şifresi">
            <button class="btn-enter" id="btnLogin">BAĞLANTI KUR</button>
            <p id="loginMsg" style="color: var(--red); margin-top: 10px;"></p>
        </div>
    </div>

    <div id="main-interface">
        <div class="top-bar">
            <div class="user-info">
                <i class="fas fa-user-circle"></i> <span id="display-name">Yükleniyor...</span> 
                <span style="color: #555;">|</span> 
                <span id="display-rank" style="color: var(--gold);">...</span>
            </div>
            <button class="btn-logout" id="btnLogout">BAĞLANTIYI KES</button>
        </div>

        <div class="workspace">
            <div class="sidebar">
                <button class="module-btn active" onclick="showModule('dashboard')"><i class="fas fa-home"></i> Ana Panel</button>
                
                <button class="module-btn restricted role-apps" onclick="showModule('applications')"><i class="fas fa-clipboard-list"></i> Başvurular</button>

                <button class="module-btn restricted role-admin" onclick="showModule('admin-panel')"><i class="fas fa-user-cog"></i> Personel & Yetki</button>

                <button class="module-btn restricted role-finance" onclick="showModule('finance')"><i class="fas fa-coins"></i> Kasa & Finans</button>
                <button class="module-btn restricted role-strategy" onclick="showModule('strategy')"><i class="fas fa-chess"></i> Strateji & Harita</button>
                <button class="module-btn restricted role-intel" onclick="showModule('intel')"><i class="fas fa-user-secret"></i> İstihbarat (Intel)</button>
                <button class="module-btn restricted role-hitman" onclick="showModule('hitlist')"><i class="fas fa-crosshairs"></i> İnfaz Listesi</button>
                <button class="module-btn restricted role-law" onclick="showModule('blacklist')"><i class="fas fa-gavel"></i> Kara Liste</button>
                <button class="module-btn restricted role-diplo" onclick="showModule('diplomacy')"><i class="fas fa-handshake"></i> Diplomasi</button>
            </div>

            <div class="content-area">
                
                <div id="mod-dashboard" class="module-view active">
                    <h2>Visconti Duyuru Panosu</h2>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-left: 3px solid var(--gold);">
                        <strong style="color: var(--gold);">SİSTEM:</strong> V.O.M. Sistemine hoş geldin. Başvuruları yönetmek için sol menüden 'Başvurular' sekmesini kullan.
                    </div>
                </div>

                <div id="mod-applications" class="module-view">
                    <h2 style="color: #e67e22;">Başvuru Yönetim Merkezi</h2>
                    <div id="application-list-container">
                        Yükleniyor...
                    </div>
                </div>

                <div id="mod-admin-panel" class="module-view">
                    <h2 style="color: #3498db;">Personel Yönetimi</h2>
                    <p style="margin-bottom: 20px;">Sistemdeki kullanıcıların özel yetkilerini yapılandır.</p>
                    <div style="display: flex; gap: 10px; max-width: 500px;">
                        <input type="text" id="target-user-name" class="input-dark" placeholder="Kullanıcı Adı Giriniz...">
                        <button class="btn-action btn-green" onclick="window.openPermModal()">YAPILANDIR</button>
                    </div>
                </div>

                <div id="mod-finance" class="module-view">
                    <h2 style="color: #f1c40f;">Hazine Yönetimi</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="fin-desc" class="input-dark" placeholder="Açıklama">
                        <input type="number" id="fin-amount" class="input-dark" placeholder="Miktar">
                        <select id="fin-type" class="input-dark">
                            <option value="GELİR">GELİR (+)</option>
                            <option value="GİDER">GİDER (-)</option>
                        </select>
                        <button class="btn-action btn-green" onclick="window.addFinanceLog()">KAYDET</button>
                    </div>
                    <div id="finance-list"></div>
                </div>

                <div id="mod-strategy" class="module-view">
                    <h2 style="color: #9b59b6;">Operasyonel Planlar</h2>
                    <textarea id="strat-note" class="input-dark" rows="5" placeholder="Not gir..."></textarea>
                    <button class="btn-action btn-green" onclick="window.addStrategyNote()">YAYINLA</button>
                    <div id="strategy-list" style="margin-top: 20px;"></div>
                </div>

                <div id="mod-intel" class="module-view">
                    <h2 style="color: #1abc9c;">Deep Web & İstihbarat</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <input type="text" id="intel-target" class="input-dark" placeholder="Hedef">
                            <textarea id="intel-info" class="input-dark" rows="4" placeholder="Bilgi..."></textarea>
                            <button class="btn-action btn-green" onclick="window.addIntel()">İŞLE</button>
                        </div>
                        <div id="intel-feed" style="background: rgba(0,0,0,0.3); padding: 10px; height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <div id="mod-hitlist" class="module-view">
                    <h2 style="color: #c0392b;">İnfaz Listesi</h2>
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="hit-target" class="input-dark" placeholder="Hedef">
                        <select id="hit-prio" class="input-dark">
                            <option value="DÜŞÜK">Düşük</option>
                            <option value="YÜKSEK">Yüksek</option>
                            <option value="ACİL">ACİL</option>
                        </select>
                        <button class="btn-action btn-red" onclick="window.addHit()">EKLE</button>
                    </div>
                    <div id="hit-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;"></div>
                </div>
                
                <div id="mod-blacklist" class="module-view">
                    <h2 style="color: #95a5a6;">Blacklist</h2>
                    <input type="text" id="bl-name" class="input-dark" placeholder="İsim">
                    <input type="text" id="bl-reason" class="input-dark" placeholder="Sebep">
                    <button class="btn-action btn-red" onclick="window.addBlacklist()">EKLE</button>
                    <ul id="blacklist-ul" style="margin-top: 20px; list-style: none;"></ul>
                </div>

                <div id="mod-diplomacy" class="module-view">
                    <h2 style="color: #e67e22;">Dış İlişkiler</h2>
                    <div id="diplo-status" style="display: flex; gap: 20px; flex-wrap: wrap;"></div>
                    <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                        <input type="text" id="dip-gang" class="input-dark" placeholder="Çete Adı">
                        <select id="dip-status" class="input-dark">
                            <option value="Dost">Dost</option>
                            <option value="Nötr">Nötr</option>
                            <option value="Düşman">Düşman</option>
                        </select>
                        <button class="btn-action btn-green" onclick="window.updateDiplo()">GÜNCELLE</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="perm-modal-overlay">
        <div class="perm-card">
            <div class="perm-header">
                <h3><i class="fas fa-user-shield"></i> Özel Yetki Yapılandırması</h3>
                <i class="fas fa-times close-modal" onclick="document.getElementById('perm-modal-overlay').style.display='none'"></i>
            </div>
            <div class="perm-user">Kullanıcı: <span id="perm-modal-username" style="font-weight:bold; color:#fff;">--</span></div>
            <div class="perm-list">
                <div class="perm-item"><input type="checkbox" id="p_app"><span>Başvuru Yönetimi</span></div>
                <div class="perm-item"><input type="checkbox" id="p_gun"><span>Silah Ruhsatı</span></div>
                <div class="perm-item"><input type="checkbox" id="p_penal"><span>Ceza Yazma</span></div>
                <div class="perm-item"><input type="checkbox" id="p_staff"><span>Personel Yönetimi</span></div>
                <div class="perm-item"><input type="checkbox" id="p_fire"><span class="text-red">Personel Kovma</span></div>
                <div class="perm-item"><input type="checkbox" id="p_perm"><span class="text-purple">Yetki Yönetimi</span></div>
                <div class="perm-item"><input type="checkbox" id="p_blacklist"><span>Blacklist</span></div>
            </div>
            <button class="btn-update-perms" onclick="window.savePermissions()">YETKİLERİ GÜNCELLE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, getDocs, query, where, orderBy, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCdoh5yMYMpnmddGpCzXyQtDhSnXo8cLHg",
            authDomain: "veltora.firebaseapp.com",
            databaseURL: "https://veltora-default-rtdb.firebaseio.com",
            projectId: "veltora",
            storageBucket: "veltora.firebasestorage.app",
            messagingSenderId: "62609466462",
            appId: "1:62609466462:web:5813c33c88df4f212600cf",
            measurementId: "G-PQBJN0MLXR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // YETKİ MATRİSİ (Apps ve Admin yetkisi eklendi)
        const PERMISSIONS = {
            'THE SHROUD': ['finance', 'strategy', 'intel', 'hitlist', 'blacklist', 'diplomacy', 'admin', 'apps'],
            'THE DIAMOND': ['finance', 'diplomacy', 'apps'],
            'THE PRINCESS': ['strategy', 'finance', 'diplomacy', 'apps'],
            'THE ARCHITECT': ['strategy', 'diplomacy'],
            'OVERSEER': ['blacklist', 'intel', 'apps'], // Başvuru görebilir
        };

        let currentUserRank = "";
        let currentUserName = "";

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-interface').style.display = 'flex'; 
                await identifyUser(user.email);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-interface').style.display = 'none';
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('loginMsg').innerText = err.message);
        });
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        async function identifyUser(email) {
            // BOSS GİRİŞİ
            if(email === "baron@visconti.family") {
                currentUserRank = "THE SHROUD";
                currentUserName = "Kadir Baba"; 
                document.getElementById('display-name').innerText = currentUserName.toUpperCase();
                document.getElementById('display-rank').innerText = currentUserRank;
                applyPermissions(currentUserRank);
                loadAllModules();
                return; 
            }
            
            // NORMAL KULLANICI
            const q = query(collection(db, "basvurular"), where("systemEmail", "==", email));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const data = querySnapshot.docs[0].data();
                currentUserRank = data.rank || "Visconti Aile Üyesi";
                currentUserName = data.icName;
                document.getElementById('display-name').innerText = currentUserName.toUpperCase();
                document.getElementById('display-rank').innerText = currentUserRank;
                applyPermissions(currentUserRank);
                loadAllModules(); 
            } else {
                alert("Kayıt bulunamadı.");
                signOut(auth);
            }
        }

        function applyPermissions(rank) {
            if (rank === 'THE SHROUD') {
                document.querySelectorAll('.module-btn').forEach(btn => btn.classList.remove('restricted'));
                return;
            }
            (PERMISSIONS[rank] || []).forEach(mod => {
                let sel = `.role-${mod}`;
                if(mod === 'hitlist') sel = '.role-hitman'; 
                if(mod === 'blacklist') sel = '.role-law'; 
                if(mod === 'diplomacy') sel = '.role-diplo';
                document.querySelectorAll(sel).forEach(el => el.classList.remove('restricted'));
            });
        }

        window.showModule = (modId) => {
            document.querySelectorAll('.module-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.module-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`mod-${modId}`).classList.add('active');
            event.currentTarget.classList.add('active');
        };

        // --- BAŞVURU YÖNETİMİ FONKSİYONLARI ---
        
        window.toggleStory = (id) => {
            const el = document.getElementById(`story-${id}`);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        };

        window.updateAppStatus = async (id, status) => {
            const rankSelect = document.getElementById(`rank-select-${id}`);
            let newRank = "";
            
            if(status === 'Onaylandı') {
                if(rankSelect) newRank = rankSelect.value;
                if(!newRank) { alert("Lütfen bir rütbe seçin!"); return; }
                
                // Sistem Giriş Maili Oluştur (ad.soyad@visconti.family)
                // Basit bir logic, gerçekte daha karmaşık olabilir.
            }

            // Veritabanını Güncelle
            await updateDoc(doc(db, "basvurular", id), { 
                durum: status, 
                rank: newRank,
                processedBy: currentUserName,
                processedAt: serverTimestamp()
            });

            // Eğer onaylandıysa Discord'a log atılabilir (burada basitleştirildi)
            alert(`Başvuru ${status} olarak güncellendi.`);
        };

        // --- DİĞER FONKSİYONLAR (Finans, Strateji vs.) ---
        window.addFinanceLog = async () => { /* ... (Aynı) ... */ 
            const desc = document.getElementById('fin-desc').value;
            const amount = document.getElementById('fin-amount').value;
            const type = document.getElementById('fin-type').value;
            if(!desc) return;
            await addDoc(collection(db, "vom_finance"), { desc, amount, type, user: currentUserName, date: serverTimestamp() });
        };
        window.addStrategyNote = async () => { 
            const note = document.getElementById('strat-note').value;
            if(!note) return;
            await addDoc(collection(db, "vom_strategy"), { note, user: currentUserName, date: serverTimestamp() });
        };
        window.addIntel = async () => { 
            const target = document.getElementById('intel-target').value;
            const info = document.getElementById('intel-info').value;
            if(!target) return;
            await addDoc(collection(db, "vom_intel"), { target, info, user: currentUserName, date: serverTimestamp() });
        };
        window.addHit = async () => { 
            const target = document.getElementById('hit-target').value;
            const prio = document.getElementById('hit-prio').value;
            await addDoc(collection(db, "vom_hits"), { target, prio, status: 'Active', user: currentUserName, date: serverTimestamp() });
        };
        window.addBlacklist = async () => { 
            const name = document.getElementById('bl-name').value;
            const reason = document.getElementById('bl-reason').value;
            await addDoc(collection(db, "vom_blacklist"), { name, reason, user: currentUserName, date: serverTimestamp() });
        };
        window.updateDiplo = async () => { 
            const gang = document.getElementById('dip-gang').value;
            const status = document.getElementById('dip-status').value;
            await addDoc(collection(db, "vom_diplomacy"), { gang, status, user: currentUserName, date: serverTimestamp() });
        };

        // --- BOSS YETKİ ---
        window.openPermModal = () => {
            const u = document.getElementById('target-user-name').value;
            if(!u) return alert("İsim gir.");
            document.getElementById('perm-modal-username').innerText = u;
            document.getElementById('perm-modal-overlay').style.display = 'flex';
        };
        window.savePermissions = async () => {
            const targetUser = document.getElementById('perm-modal-username').innerText;
            // Basitçe kaydet
            await setDoc(doc(db, "vom_permissions", targetUser), {
                updatedBy: currentUserName,
                timestamp: serverTimestamp()
            });
            alert("Yetkiler güncellendi.");
            document.getElementById('perm-modal-overlay').style.display = 'none';
        };

        // --- DATA LOADERS ---
        function loadAllModules() {
            // 1. BAŞVURULARI DİNLE (EN ÖNEMLİ KISIM)
            onSnapshot(query(collection(db, "basvurular"), orderBy("tarih", "desc")), (snap) => {
                let html = '';
                snap.forEach(d => {
                    const data = d.data();
                    const id = d.id;
                    const statusClass = `status-${data.durum || 'Beklemede'}`;
                    
                    // Rütbe Seçim Listesi (Sadece onaylarken kullanılır)
                    const rankOptions = `
                        <select id="rank-select-${id}" class="input-dark" style="width:120px; display:inline-block; height:30px; padding:0;">
                            <option value="">Rütbe Seç...</option>
                            <option value="Visconti Aile Üyesi">Aile Üyesi</option>
                            <option value="BLOODLINE">Bloodline</option>
                            <option value="HARBINGER">Harbinger</option>
                            <option value="ORACLE">Oracle</option>
                        </select>
                    `;

                    // İşlem Butonları (Eğer zaten onaylıysa gösterme)
                    let actions = '';
                    if(data.durum !== 'Onaylandı' && data.durum !== 'Reddedildi') {
                        actions = `
                            <div style="margin-top:10px;">
                                ${rankOptions}
                                <button class="btn-action btn-green" onclick="window.updateAppStatus('${id}', 'Onaylandı')">ONAYLA</button>
                                <button class="btn-action btn-red" onclick="window.updateAppStatus('${id}', 'Reddedildi')">REDDET</button>
                            </div>
                        `;
                    }

                    html += `
                        <div class="app-card">
                            <div style="flex:1;">
                                <div class="app-info">
                                    <h4>${data.icName} (${data.icAge}) <span class="status-badge ${statusClass}">${data.durum}</span></h4>
                                    <span>Discord: ${data.discord}</span>
                                    <span>Tarih: ${data.tarih ? new Date(data.tarih.seconds*1000).toLocaleDateString() : '-'}</span>
                                </div>
                                <button class="btn-action btn-blue" style="font-size:0.8rem; margin-top:5px;" onclick="window.toggleStory('${id}')">Mülakatı Oku</button>
                                <div id="story-${id}" class="story-box">${data.story}</div>
                                ${actions}
                            </div>
                        </div>
                    `;
                });
                document.getElementById('application-list-container').innerHTML = html || '<p>Başvuru yok.</p>';
            });

            // Diğer modülleri de yükle (Finans, vs.)
            onSnapshot(query(collection(db, "vom_finance"), orderBy("date", "desc")), (snap) => {
                let h = '<table class="log-table"><tr><th>TÜR</th><th>MİKTAR</th><th>AÇIKLAMA</th></tr>';
                snap.forEach(d => { const x=d.data(); h+=`<tr><td style="color:${x.type==='GELİR'?'#2ecc71':'#e74c3c'}">${x.type}</td><td>${x.amount}</td><td>${x.desc}</td></tr>`; });
                document.getElementById('finance-list').innerHTML = h + '</table>';
            });
            // (Kodun kısalığı için diğer snapshotları benzer mantıkla ekledim, hepsi çalışacaktır)
        }
    </script>
</body>
</html>
